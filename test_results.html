
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Test Results</title>
        <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/themes/prism-okaidia.min.css" rel="stylesheet" />
        <style>
            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                margin: 20px;
            }
            table {
                border-collapse: collapse;
                width: 100%;
                box-shadow: 0 2px 3px rgba(0,0,0,0.1);
            }
            th, td {
                border: 1px solid #ddd;
                text-align: left;
                padding: 8px;
            }
            th {
                background-color: #f2f2f2;
            }
            tr:nth-child(even) {
                background-color: #f9f9f9;
            }
            .status-pass {
                color: green;
            }
            .status-fail {
                color: red;
            }
            pre {
                background-color: #282c34 !important;
                color: #ffffff !important;
                padding: 10px;
                border-radius: 5px;
                overflow-x: auto;
                white-space: pre-wrap;
                font-family: 'Courier New', Courier, monospace;
                font-size: 1.1em;  /* Slightly larger font size */
            }
        </style>
    </head>
    <body>
        <table>
            <tr>
                <th>Status</th>
                <th>Reason</th>
                <th>Exit Code</th>
                <th>Language</th>
                <th>Modified Test File</th>
                <th>Details</th>
            </tr>
            
            <tr>
                <td class="status-FAIL">FAIL</td>
                <td>Test failed</td>
                <td>1</td>
                <td>go</td>
                <td>
                    <details>
                        <summary>View Full Code</summary>
                        <pre><code><span class="diff-unchanged">  package localvolume</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  import (</span>
<span class="diff-unchanged">  	"context"</span>
<span class="diff-unchanged">  	"fmt"</span>
<span class="diff-unchanged">  	"strings"</span>
<span class="diff-unchanged">  	"testing"</span>
<span class="diff-unchanged">  	"time"</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"</span>
<span class="diff-unchanged">  	"k8s.io/apimachinery/pkg/runtime"</span>
<span class="diff-unchanged">  	"k8s.io/apimachinery/pkg/types"</span>
<span class="diff-unchanged">  	"k8s.io/client-go/kubernetes/scheme"</span>
<span class="diff-unchanged">  	"k8s.io/client-go/tools/record"</span>
<span class="diff-unchanged">  	"sigs.k8s.io/controller-runtime/pkg/cache"</span>
<span class="diff-unchanged">  	"sigs.k8s.io/controller-runtime/pkg/client"</span>
<span class="diff-unchanged">  	"sigs.k8s.io/controller-runtime/pkg/client/fake"</span>
<span class="diff-unchanged">  	"sigs.k8s.io/controller-runtime/pkg/reconcile"</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	apisv1alpha1 "github.com/hwameistor/hwameistor/pkg/apis/hwameistor/v1alpha1"</span>
<span class="diff-unchanged">  	"github.com/hwameistor/hwameistor/pkg/local-storage/member"</span>
<span class="diff-unchanged">  )</span>
<span class="diff-added">+ sigs.k8s.io/controller-runtime/pkg/manager</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  // SystemMode of HA module</span>
<span class="diff-unchanged">  type SystemMode string</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  var (</span>
<span class="diff-unchanged">  	fakeLocalVolumeName          = "local-volume-example"</span>
<span class="diff-unchanged">  	fakeLocalVolumeUID           = "local-volume-uid"</span>
<span class="diff-unchanged">  	fakeNamespace                = "local-volume-test"</span>
<span class="diff-unchanged">  	fakeNodenames                = []string{"10-6-118-10"}</span>
<span class="diff-unchanged">  	fakeNodename                 = "10-6-118-10"</span>
<span class="diff-unchanged">  	fakeStorageIp                = "10.6.118.11"</span>
<span class="diff-unchanged">  	fakeZone                     = "zone-test"</span>
<span class="diff-unchanged">  	fakeRegion                   = "region-test"</span>
<span class="diff-unchanged">  	fakeVgType                   = "LocalStorage_PoolHDD"</span>
<span class="diff-unchanged">  	fakeVgName                   = "vg-test"</span>
<span class="diff-unchanged">  	fakePoolClass                = "HDD"</span>
<span class="diff-unchanged">  	fakePoolType                 = "REGULAR"</span>
<span class="diff-unchanged">  	fakeTotalCapacityBytes int64 = 10 * 1024 * 1024 * 1024</span>
<span class="diff-unchanged">  	fakeFreeCapacityBytes  int64 = 8 * 1024 * 1024 * 1024</span>
<span class="diff-unchanged">  	fakeDiskCapacityBytes  int64 = 2 * 1024 * 1024 * 1024</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	apiversion      = "hwameistor.io/v1alpha1"</span>
<span class="diff-unchanged">  	LocalVolumeKind = "LocalVolume"</span>
<span class="diff-unchanged">  	fakeRecorder    = record.NewFakeRecorder(100)</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	defaultDRBDStartPort                 = 43001</span>
<span class="diff-unchanged">  	defaultHAVolumeTotalCount            = 1000</span>
<span class="diff-unchanged">  	SystemModeDRBD            SystemMode = "drbd"</span>
<span class="diff-unchanged">  )</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  func TestNewLocalVolumeController(t *testing.T) {</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	systemConfig, err := getSystemConfig()</span>
<span class="diff-unchanged">  	if err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("invalid system config: %s", err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	var ca cache.Cache</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	cli, s := CreateFakeClient()</span>
<span class="diff-unchanged">  	// Create a Reconcile for LocalVolume</span>
<span class="diff-unchanged">  	r := ReconcileLocalVolume{</span>
<span class="diff-unchanged">  		client:        cli,</span>
<span class="diff-unchanged">  		scheme:        s,</span>
<span class="diff-unchanged">  		storageMember: member.Member().ConfigureController(s).ConfigureBase(fakeNodename, fakeNamespace, systemConfig, 0, cli, ca, fakeRecorder).ConfigureNode(s),</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	// Create LocalVolume</span>
<span class="diff-unchanged">  	lv := GenFakeLocalVolumeObject()</span>
<span class="diff-unchanged">  	err = r.client.Create(context.Background(), lv)</span>
<span class="diff-unchanged">  	if err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("Create LocalVolume fail %v", err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	defer r.DeleteFakeLocalVolume(t, lv)</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	// Get lv</span>
<span class="diff-unchanged">  	err = r.client.Get(context.Background(), types.NamespacedName{Namespace: lv.GetNamespace(), Name: lv.GetName()}, lv)</span>
<span class="diff-unchanged">  	if err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("Get lv fail %v", err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	fmt.Printf("lv = %+v", lv)</span>
<span class="diff-unchanged">  	fmt.Printf("r.storageMember = %+v", r.storageMember)</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	// Mock LocalVolume request</span>
<span class="diff-unchanged">  	req := reconcile.Request{NamespacedName: types.NamespacedName{Namespace: lv.GetNamespace(), Name: lv.GetName()}}</span>
<span class="diff-unchanged">  	_, err = r.Reconcile(context.TODO(), req)</span>
<span class="diff-unchanged">  	if err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("Reconcile fail %v", err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  }</span>
<span class="diff-added">+ </span>
<span class="diff-added">+ func TestAddFunction(t *testing.T) {</span>
<span class="diff-added">+     cli, s := CreateFakeClient()</span>
<span class="diff-added">+     mgr := &fakeManager{client: cli, scheme: s}</span>
<span class="diff-added">+ </span>
<span class="diff-added">+     err := Add(mgr)</span>
<span class="diff-added">+     if err != nil {</span>
<span class="diff-added">+         t.Errorf("Add function failed: %v", err)</span>
<span class="diff-added">+     }</span>
<span class="diff-added">+ }</span>
<span class="diff-added">+ </span>
<span class="diff-added">+ type fakeManager struct {</span>
<span class="diff-added">+     client client.Client</span>
<span class="diff-added">+     scheme *runtime.Scheme</span>
<span class="diff-added">+ }</span>
<span class="diff-added">+ </span>
<span class="diff-added">+ func (f *fakeManager) GetClient() client.Client {</span>
<span class="diff-added">+     return f.client</span>
<span class="diff-added">+ }</span>
<span class="diff-added">+ </span>
<span class="diff-added">+ func (f *fakeManager) GetScheme() *runtime.Scheme {</span>
<span class="diff-added">+     return f.scheme</span>
<span class="diff-added">+ }</span>
<span class="diff-added">+ </span>
<span class="diff-added">+ func (f *fakeManager) GetCache() cache.Cache {</span>
<span class="diff-added">+     return nil</span>
<span class="diff-added">+ }</span>
<span class="diff-added">+ </span>
<span class="diff-added">+ func (f *fakeManager) GetEventRecorderFor(name string) record.EventRecorder {</span>
<span class="diff-added">+     return fakeRecorder</span>
<span class="diff-added">+ }</span>
<span class="diff-added">+ </span>
<span class="diff-added">+ func (f *fakeManager) Start(ctx context.Context) error {</span>
<span class="diff-added">+     return nil</span>
<span class="diff-added">+ }</span>
<span class="diff-added">+ </span>
<span class="diff-added">+ func (f *fakeManager) Add(manager.Runnable) error {</span>
<span class="diff-added">+     return nil</span>
<span class="diff-added">+ }</span>
<span class="diff-added">+ </span>
<span class="diff-added">+ func (f *fakeManager) SetFields(interface{}) error {</span>
<span class="diff-added">+     return nil</span>
<span class="diff-added">+ }</span>
<span class="diff-added">+ </span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  // DeleteFakeLocalVolume</span>
<span class="diff-unchanged">  func (r *ReconcileLocalVolume) DeleteFakeLocalVolume(t *testing.T, lv *apisv1alpha1.LocalVolume) {</span>
<span class="diff-unchanged">  	if err := r.client.Delete(context.Background(), lv); err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("Delete LocalVolume %v fail %v", lv.GetName(), err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  // GenFakeLocalVolumeObject Create lv request</span>
<span class="diff-unchanged">  func GenFakeLocalVolumeObject() *apisv1alpha1.LocalVolume {</span>
<span class="diff-unchanged">  	lv := &apisv1alpha1.LocalVolume{}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	TypeMeta := metav1.TypeMeta{</span>
<span class="diff-unchanged">  		Kind:       LocalVolumeKind,</span>
<span class="diff-unchanged">  		APIVersion: apiversion,</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	ObjectMata := metav1.ObjectMeta{</span>
<span class="diff-unchanged">  		Name:              fakeLocalVolumeName,</span>
<span class="diff-unchanged">  		Namespace:         fakeNamespace,</span>
<span class="diff-unchanged">  		ResourceVersion:   "",</span>
<span class="diff-unchanged">  		UID:               types.UID(fakeLocalVolumeUID),</span>
<span class="diff-unchanged">  		CreationTimestamp: metav1.Time{Time: time.Now()},</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	Spec := apisv1alpha1.LocalVolumeSpec{</span>
<span class="diff-unchanged">  		RequiredCapacityBytes: fakeDiskCapacityBytes,</span>
<span class="diff-unchanged">  		ReplicaNumber:         1,</span>
<span class="diff-unchanged">  		PoolName:              fakeVgType,</span>
<span class="diff-unchanged">  		Delete:                false,</span>
<span class="diff-unchanged">  		Convertible:           true,</span>
<span class="diff-unchanged">  		Accessibility: apisv1alpha1.AccessibilityTopology{</span>
<span class="diff-unchanged">  			Nodes:   fakeNodenames,</span>
<span class="diff-unchanged">  			Regions: []string{fakeRegion},</span>
<span class="diff-unchanged">  			Zones:   []string{fakeZone},</span>
<span class="diff-unchanged">  		},</span>
<span class="diff-unchanged">  		Config: &apisv1alpha1.VolumeConfig{</span>
<span class="diff-unchanged">  			Convertible:           true,</span>
<span class="diff-unchanged">  			Initialized:           true,</span>
<span class="diff-unchanged">  			ReadyToInitialize:     true,</span>
<span class="diff-unchanged">  			RequiredCapacityBytes: fakeDiskCapacityBytes,</span>
<span class="diff-unchanged">  			ResourceID:            5,</span>
<span class="diff-unchanged">  			Version:               11,</span>
<span class="diff-unchanged">  			VolumeName:            fakeLocalVolumeName,</span>
<span class="diff-unchanged">  			Replicas: []apisv1alpha1.VolumeReplica{</span>
<span class="diff-unchanged">  				{</span>
<span class="diff-unchanged">  					Hostname: fakeNodename,</span>
<span class="diff-unchanged">  					ID:       1,</span>
<span class="diff-unchanged">  					IP:       fakeStorageIp,</span>
<span class="diff-unchanged">  					Primary:  true,</span>
<span class="diff-unchanged">  				},</span>
<span class="diff-unchanged">  			},</span>
<span class="diff-unchanged">  		},</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	lv.ObjectMeta = ObjectMata</span>
<span class="diff-unchanged">  	lv.TypeMeta = TypeMeta</span>
<span class="diff-unchanged">  	lv.Spec = Spec</span>
<span class="diff-unchanged">  	lv.Status.State = apisv1alpha1.VolumeStateCreating</span>
<span class="diff-unchanged">  	lv.Status.AllocatedCapacityBytes = fakeTotalCapacityBytes - fakeFreeCapacityBytes</span>
<span class="diff-unchanged">  	lv.Status.PublishedNodeName = fakeNodename</span>
<span class="diff-unchanged">  	lv.Status.Replicas = []string{fakeLocalVolumeName}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	return lv</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  // CreateFakeClient Create LocalVolume resource</span>
<span class="diff-unchanged">  func CreateFakeClient() (client.Client, *runtime.Scheme) {</span>
<span class="diff-unchanged">  	lv := GenFakeLocalVolumeObject()</span>
<span class="diff-unchanged">  	lvList := &apisv1alpha1.LocalVolumeList{</span>
<span class="diff-unchanged">  		TypeMeta: metav1.TypeMeta{</span>
<span class="diff-unchanged">  			Kind:       LocalVolumeKind,</span>
<span class="diff-unchanged">  			APIVersion: apiversion,</span>
<span class="diff-unchanged">  		},</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	s := scheme.Scheme</span>
<span class="diff-unchanged">  	s.AddKnownTypes(apisv1alpha1.SchemeGroupVersion, lv)</span>
<span class="diff-unchanged">  	s.AddKnownTypes(apisv1alpha1.SchemeGroupVersion, lvList)</span>
<span class="diff-unchanged">  	return fake.NewClientBuilder().WithScheme(s).Build(), s</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  func validateSystemConfig() error {</span>
<span class="diff-unchanged">  	var errMsgs []string</span>
<span class="diff-unchanged">  	switch apisv1alpha1.SystemMode(SystemModeDRBD) {</span>
<span class="diff-unchanged">  	case apisv1alpha1.SystemModeDRBD:</span>
<span class="diff-unchanged">  	default:</span>
<span class="diff-unchanged">  		errMsgs = append(errMsgs, fmt.Sprintf("system mode %s not supported", SystemModeDRBD))</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	if len(errMsgs) != 0 {</span>
<span class="diff-unchanged">  		return fmt.Errorf(strings.Join(errMsgs, "; "))</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	return nil</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  func getSystemConfig() (apisv1alpha1.SystemConfig, error) {</span>
<span class="diff-unchanged">  	if err := validateSystemConfig(); err != nil {</span>
<span class="diff-unchanged">  		return apisv1alpha1.SystemConfig{}, err</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	config := apisv1alpha1.SystemConfig{</span>
<span class="diff-unchanged">  		Mode:             apisv1alpha1.SystemMode(SystemModeDRBD),</span>
<span class="diff-unchanged">  		MaxHAVolumeCount: defaultHAVolumeTotalCount,</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	switch config.Mode {</span>
<span class="diff-unchanged">  	case apisv1alpha1.SystemModeDRBD:</span>
<span class="diff-unchanged">  		{</span>
<span class="diff-unchanged">  			config.DRBD = &apisv1alpha1.DRBDSystemConfig{</span>
<span class="diff-unchanged">  				StartPort: defaultDRBDStartPort,</span>
<span class="diff-unchanged">  			}</span>
<span class="diff-unchanged">  		}</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	return config, nil</span>
<span class="diff-unchanged">  }</span></code></pre>
                    </details>
                </td>
                <td>
                    <details>
                        <summary>View More</summary>
                        <div><strong>STDERR:</strong> <pre><code class="language-go"># github.com/hwameistor/hwameistor/pkg/local-storage/controller/localvolume
pkg/local-storage/controller/localvolume/localvolume_controller_test.go:23:1: expected declaration, found sigs
</code></pre></div>
                        <div><strong>STDOUT:</strong> <pre><code class="language-go">FAIL	github.com/hwameistor/hwameistor/pkg/local-storage/controller/localvolume [setup failed]
FAIL
</code></pre></div>
                        <div><strong>Test Code:</strong> <pre><code class="language-go">func TestAddFunction(t *testing.T) {
    cli, s := CreateFakeClient()
    mgr := &fakeManager{client: cli, scheme: s}

    err := Add(mgr)
    if err != nil {
        t.Errorf("Add function failed: %v", err)
    }
}

type fakeManager struct {
    client client.Client
    scheme *runtime.Scheme
}

func (f *fakeManager) GetClient() client.Client {
    return f.client
}

func (f *fakeManager) GetScheme() *runtime.Scheme {
    return f.scheme
}

func (f *fakeManager) GetCache() cache.Cache {
    return nil
}

func (f *fakeManager) GetEventRecorderFor(name string) record.EventRecorder {
    return fakeRecorder
}

func (f *fakeManager) Start(ctx context.Context) error {
    return nil
}

func (f *fakeManager) Add(manager.Runnable) error {
    return nil
}

func (f *fakeManager) SetFields(interface{}) error {
    return nil
}
</code></pre></div>
                        <div><strong>Imports:</strong> <pre><code class="language-go">"sigs.k8s.io/controller-runtime/pkg/manager"
</code></pre></div>
                    </details>
                </td>
            </tr>
            
            <tr>
                <td class="status-FAIL">FAIL</td>
                <td>Test failed</td>
                <td>2</td>
                <td>go</td>
                <td>
                    <details>
                        <summary>View Full Code</summary>
                        <pre><code><span class="diff-unchanged">  package localvolume</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  import (</span>
<span class="diff-unchanged">  	"context"</span>
<span class="diff-unchanged">  	"fmt"</span>
<span class="diff-unchanged">  	"strings"</span>
<span class="diff-unchanged">  	"testing"</span>
<span class="diff-unchanged">  	"time"</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"</span>
<span class="diff-unchanged">  	"k8s.io/apimachinery/pkg/runtime"</span>
<span class="diff-unchanged">  	"k8s.io/apimachinery/pkg/types"</span>
<span class="diff-unchanged">  	"k8s.io/client-go/kubernetes/scheme"</span>
<span class="diff-unchanged">  	"k8s.io/client-go/tools/record"</span>
<span class="diff-unchanged">  	"sigs.k8s.io/controller-runtime/pkg/cache"</span>
<span class="diff-unchanged">  	"sigs.k8s.io/controller-runtime/pkg/client"</span>
<span class="diff-unchanged">  	"sigs.k8s.io/controller-runtime/pkg/client/fake"</span>
<span class="diff-unchanged">  	"sigs.k8s.io/controller-runtime/pkg/reconcile"</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	apisv1alpha1 "github.com/hwameistor/hwameistor/pkg/apis/hwameistor/v1alpha1"</span>
<span class="diff-unchanged">  	"github.com/hwameistor/hwameistor/pkg/local-storage/member"</span>
<span class="diff-unchanged">  )</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  // SystemMode of HA module</span>
<span class="diff-unchanged">  type SystemMode string</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  var (</span>
<span class="diff-unchanged">  	fakeLocalVolumeName          = "local-volume-example"</span>
<span class="diff-unchanged">  	fakeLocalVolumeUID           = "local-volume-uid"</span>
<span class="diff-unchanged">  	fakeNamespace                = "local-volume-test"</span>
<span class="diff-unchanged">  	fakeNodenames                = []string{"10-6-118-10"}</span>
<span class="diff-unchanged">  	fakeNodename                 = "10-6-118-10"</span>
<span class="diff-unchanged">  	fakeStorageIp                = "10.6.118.11"</span>
<span class="diff-unchanged">  	fakeZone                     = "zone-test"</span>
<span class="diff-unchanged">  	fakeRegion                   = "region-test"</span>
<span class="diff-unchanged">  	fakeVgType                   = "LocalStorage_PoolHDD"</span>
<span class="diff-unchanged">  	fakeVgName                   = "vg-test"</span>
<span class="diff-unchanged">  	fakePoolClass                = "HDD"</span>
<span class="diff-unchanged">  	fakePoolType                 = "REGULAR"</span>
<span class="diff-unchanged">  	fakeTotalCapacityBytes int64 = 10 * 1024 * 1024 * 1024</span>
<span class="diff-unchanged">  	fakeFreeCapacityBytes  int64 = 8 * 1024 * 1024 * 1024</span>
<span class="diff-unchanged">  	fakeDiskCapacityBytes  int64 = 2 * 1024 * 1024 * 1024</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	apiversion      = "hwameistor.io/v1alpha1"</span>
<span class="diff-unchanged">  	LocalVolumeKind = "LocalVolume"</span>
<span class="diff-unchanged">  	fakeRecorder    = record.NewFakeRecorder(100)</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	defaultDRBDStartPort                 = 43001</span>
<span class="diff-unchanged">  	defaultHAVolumeTotalCount            = 1000</span>
<span class="diff-unchanged">  	SystemModeDRBD            SystemMode = "drbd"</span>
<span class="diff-unchanged">  )</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  func TestNewLocalVolumeController(t *testing.T) {</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	systemConfig, err := getSystemConfig()</span>
<span class="diff-unchanged">  	if err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("invalid system config: %s", err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	var ca cache.Cache</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	cli, s := CreateFakeClient()</span>
<span class="diff-unchanged">  	// Create a Reconcile for LocalVolume</span>
<span class="diff-unchanged">  	r := ReconcileLocalVolume{</span>
<span class="diff-unchanged">  		client:        cli,</span>
<span class="diff-unchanged">  		scheme:        s,</span>
<span class="diff-unchanged">  		storageMember: member.Member().ConfigureController(s).ConfigureBase(fakeNodename, fakeNamespace, systemConfig, 0, cli, ca, fakeRecorder).ConfigureNode(s),</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	// Create LocalVolume</span>
<span class="diff-unchanged">  	lv := GenFakeLocalVolumeObject()</span>
<span class="diff-unchanged">  	err = r.client.Create(context.Background(), lv)</span>
<span class="diff-unchanged">  	if err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("Create LocalVolume fail %v", err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	defer r.DeleteFakeLocalVolume(t, lv)</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	// Get lv</span>
<span class="diff-unchanged">  	err = r.client.Get(context.Background(), types.NamespacedName{Namespace: lv.GetNamespace(), Name: lv.GetName()}, lv)</span>
<span class="diff-unchanged">  	if err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("Get lv fail %v", err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	fmt.Printf("lv = %+v", lv)</span>
<span class="diff-unchanged">  	fmt.Printf("r.storageMember = %+v", r.storageMember)</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	// Mock LocalVolume request</span>
<span class="diff-unchanged">  	req := reconcile.Request{NamespacedName: types.NamespacedName{Namespace: lv.GetNamespace(), Name: lv.GetName()}}</span>
<span class="diff-unchanged">  	_, err = r.Reconcile(context.TODO(), req)</span>
<span class="diff-unchanged">  	if err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("Reconcile fail %v", err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  }</span>
<span class="diff-added">+ </span>
<span class="diff-added">+ func TestAddFunctionWithInvalidObject(t *testing.T) {</span>
<span class="diff-added">+     cli, s := CreateFakeClient()</span>
<span class="diff-added">+     mgr := &fakeManager{client: cli, scheme: s}</span>
<span class="diff-added">+ </span>
<span class="diff-added">+     invalidObject := &apisv1alpha1.LocalVolume{}</span>
<span class="diff-added">+     replicaToVolumeRequestFunc := handler.EnqueueRequestsFromMapFunc(</span>
<span class="diff-added">+         func(a client.Object) []reconcile.Request {</span>
<span class="diff-added">+             replica, ok := a.(*apisv1alpha1.LocalVolumeReplica)</span>
<span class="diff-added">+             if !ok {</span>
<span class="diff-added">+                 return []reconcile.Request{}</span>
<span class="diff-added">+             }</span>
<span class="diff-added">+             return []reconcile.Request{</span>
<span class="diff-added">+                 {</span>
<span class="diff-added">+                     NamespacedName: types.NamespacedName{Name: replica.Spec.VolumeName},</span>
<span class="diff-added">+                 },</span>
<span class="diff-added">+             }</span>
<span class="diff-added">+         })</span>
<span class="diff-added">+ </span>
<span class="diff-added">+     requests := replicaToVolumeRequestFunc(invalidObject)</span>
<span class="diff-added">+     if len(requests) != 0 {</span>
<span class="diff-added">+         t.Errorf("Expected no requests for invalid object, but got %v", requests)</span>
<span class="diff-added">+     }</span>
<span class="diff-added">+ }</span>
<span class="diff-added">+ </span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  // DeleteFakeLocalVolume</span>
<span class="diff-unchanged">  func (r *ReconcileLocalVolume) DeleteFakeLocalVolume(t *testing.T, lv *apisv1alpha1.LocalVolume) {</span>
<span class="diff-unchanged">  	if err := r.client.Delete(context.Background(), lv); err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("Delete LocalVolume %v fail %v", lv.GetName(), err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  // GenFakeLocalVolumeObject Create lv request</span>
<span class="diff-unchanged">  func GenFakeLocalVolumeObject() *apisv1alpha1.LocalVolume {</span>
<span class="diff-unchanged">  	lv := &apisv1alpha1.LocalVolume{}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	TypeMeta := metav1.TypeMeta{</span>
<span class="diff-unchanged">  		Kind:       LocalVolumeKind,</span>
<span class="diff-unchanged">  		APIVersion: apiversion,</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	ObjectMata := metav1.ObjectMeta{</span>
<span class="diff-unchanged">  		Name:              fakeLocalVolumeName,</span>
<span class="diff-unchanged">  		Namespace:         fakeNamespace,</span>
<span class="diff-unchanged">  		ResourceVersion:   "",</span>
<span class="diff-unchanged">  		UID:               types.UID(fakeLocalVolumeUID),</span>
<span class="diff-unchanged">  		CreationTimestamp: metav1.Time{Time: time.Now()},</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	Spec := apisv1alpha1.LocalVolumeSpec{</span>
<span class="diff-unchanged">  		RequiredCapacityBytes: fakeDiskCapacityBytes,</span>
<span class="diff-unchanged">  		ReplicaNumber:         1,</span>
<span class="diff-unchanged">  		PoolName:              fakeVgType,</span>
<span class="diff-unchanged">  		Delete:                false,</span>
<span class="diff-unchanged">  		Convertible:           true,</span>
<span class="diff-unchanged">  		Accessibility: apisv1alpha1.AccessibilityTopology{</span>
<span class="diff-unchanged">  			Nodes:   fakeNodenames,</span>
<span class="diff-unchanged">  			Regions: []string{fakeRegion},</span>
<span class="diff-unchanged">  			Zones:   []string{fakeZone},</span>
<span class="diff-unchanged">  		},</span>
<span class="diff-unchanged">  		Config: &apisv1alpha1.VolumeConfig{</span>
<span class="diff-unchanged">  			Convertible:           true,</span>
<span class="diff-unchanged">  			Initialized:           true,</span>
<span class="diff-unchanged">  			ReadyToInitialize:     true,</span>
<span class="diff-unchanged">  			RequiredCapacityBytes: fakeDiskCapacityBytes,</span>
<span class="diff-unchanged">  			ResourceID:            5,</span>
<span class="diff-unchanged">  			Version:               11,</span>
<span class="diff-unchanged">  			VolumeName:            fakeLocalVolumeName,</span>
<span class="diff-unchanged">  			Replicas: []apisv1alpha1.VolumeReplica{</span>
<span class="diff-unchanged">  				{</span>
<span class="diff-unchanged">  					Hostname: fakeNodename,</span>
<span class="diff-unchanged">  					ID:       1,</span>
<span class="diff-unchanged">  					IP:       fakeStorageIp,</span>
<span class="diff-unchanged">  					Primary:  true,</span>
<span class="diff-unchanged">  				},</span>
<span class="diff-unchanged">  			},</span>
<span class="diff-unchanged">  		},</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	lv.ObjectMeta = ObjectMata</span>
<span class="diff-unchanged">  	lv.TypeMeta = TypeMeta</span>
<span class="diff-unchanged">  	lv.Spec = Spec</span>
<span class="diff-unchanged">  	lv.Status.State = apisv1alpha1.VolumeStateCreating</span>
<span class="diff-unchanged">  	lv.Status.AllocatedCapacityBytes = fakeTotalCapacityBytes - fakeFreeCapacityBytes</span>
<span class="diff-unchanged">  	lv.Status.PublishedNodeName = fakeNodename</span>
<span class="diff-unchanged">  	lv.Status.Replicas = []string{fakeLocalVolumeName}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	return lv</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  // CreateFakeClient Create LocalVolume resource</span>
<span class="diff-unchanged">  func CreateFakeClient() (client.Client, *runtime.Scheme) {</span>
<span class="diff-unchanged">  	lv := GenFakeLocalVolumeObject()</span>
<span class="diff-unchanged">  	lvList := &apisv1alpha1.LocalVolumeList{</span>
<span class="diff-unchanged">  		TypeMeta: metav1.TypeMeta{</span>
<span class="diff-unchanged">  			Kind:       LocalVolumeKind,</span>
<span class="diff-unchanged">  			APIVersion: apiversion,</span>
<span class="diff-unchanged">  		},</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	s := scheme.Scheme</span>
<span class="diff-unchanged">  	s.AddKnownTypes(apisv1alpha1.SchemeGroupVersion, lv)</span>
<span class="diff-unchanged">  	s.AddKnownTypes(apisv1alpha1.SchemeGroupVersion, lvList)</span>
<span class="diff-unchanged">  	return fake.NewClientBuilder().WithScheme(s).Build(), s</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  func validateSystemConfig() error {</span>
<span class="diff-unchanged">  	var errMsgs []string</span>
<span class="diff-unchanged">  	switch apisv1alpha1.SystemMode(SystemModeDRBD) {</span>
<span class="diff-unchanged">  	case apisv1alpha1.SystemModeDRBD:</span>
<span class="diff-unchanged">  	default:</span>
<span class="diff-unchanged">  		errMsgs = append(errMsgs, fmt.Sprintf("system mode %s not supported", SystemModeDRBD))</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	if len(errMsgs) != 0 {</span>
<span class="diff-unchanged">  		return fmt.Errorf(strings.Join(errMsgs, "; "))</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	return nil</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  func getSystemConfig() (apisv1alpha1.SystemConfig, error) {</span>
<span class="diff-unchanged">  	if err := validateSystemConfig(); err != nil {</span>
<span class="diff-unchanged">  		return apisv1alpha1.SystemConfig{}, err</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	config := apisv1alpha1.SystemConfig{</span>
<span class="diff-unchanged">  		Mode:             apisv1alpha1.SystemMode(SystemModeDRBD),</span>
<span class="diff-unchanged">  		MaxHAVolumeCount: defaultHAVolumeTotalCount,</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	switch config.Mode {</span>
<span class="diff-unchanged">  	case apisv1alpha1.SystemModeDRBD:</span>
<span class="diff-unchanged">  		{</span>
<span class="diff-unchanged">  			config.DRBD = &apisv1alpha1.DRBDSystemConfig{</span>
<span class="diff-unchanged">  				StartPort: defaultDRBDStartPort,</span>
<span class="diff-unchanged">  			}</span>
<span class="diff-unchanged">  		}</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	return config, nil</span>
<span class="diff-unchanged">  }</span></code></pre>
                    </details>
                </td>
                <td>
                    <details>
                        <summary>View More</summary>
                        <div><strong>STDERR:</strong> <pre><code class="language-go"># github.com/hwameistor/hwameistor/pkg/local-storage/controller/localvolume [github.com/hwameistor/hwameistor/pkg/local-storage/controller/localvolume.test]
pkg/local-storage/controller/localvolume/localvolume_controller_test.go:96:5: mgr declared but not used
pkg/local-storage/controller/localvolume/localvolume_controller_test.go:96:13: undefined: fakeManager
pkg/local-storage/controller/localvolume/localvolume_controller_test.go:99:35: undefined: handler
note: module requires Go 1.21
</code></pre></div>
                        <div><strong>STDOUT:</strong> <pre><code class="language-go">FAIL	github.com/hwameistor/hwameistor/pkg/local-storage/controller/localvolume [build failed]
FAIL
</code></pre></div>
                        <div><strong>Test Code:</strong> <pre><code class="language-go">func TestAddFunctionWithInvalidObject(t *testing.T) {
    cli, s := CreateFakeClient()
    mgr := &fakeManager{client: cli, scheme: s}

    invalidObject := &apisv1alpha1.LocalVolume{}
    replicaToVolumeRequestFunc := handler.EnqueueRequestsFromMapFunc(
        func(a client.Object) []reconcile.Request {
            replica, ok := a.(*apisv1alpha1.LocalVolumeReplica)
            if !ok {
                return []reconcile.Request{}
            }
            return []reconcile.Request{
                {
                    NamespacedName: types.NamespacedName{Name: replica.Spec.VolumeName},
                },
            }
        })

    requests := replicaToVolumeRequestFunc(invalidObject)
    if len(requests) != 0 {
        t.Errorf("Expected no requests for invalid object, but got %v", requests)
    }
}
</code></pre></div>
                        <div><strong>Imports:</strong> <pre><code class="language-go">""
</code></pre></div>
                    </details>
                </td>
            </tr>
            
            <tr>
                <td class="status-PASS">PASS</td>
                <td></td>
                <td>0</td>
                <td>go</td>
                <td>
                    <details>
                        <summary>View Full Code</summary>
                        <pre><code><span class="diff-unchanged">  package localvolume</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  import (</span>
<span class="diff-unchanged">  	"context"</span>
<span class="diff-unchanged">  	"fmt"</span>
<span class="diff-unchanged">  	"strings"</span>
<span class="diff-unchanged">  	"testing"</span>
<span class="diff-unchanged">  	"time"</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"</span>
<span class="diff-unchanged">  	"k8s.io/apimachinery/pkg/runtime"</span>
<span class="diff-unchanged">  	"k8s.io/apimachinery/pkg/types"</span>
<span class="diff-unchanged">  	"k8s.io/client-go/kubernetes/scheme"</span>
<span class="diff-unchanged">  	"k8s.io/client-go/tools/record"</span>
<span class="diff-unchanged">  	"sigs.k8s.io/controller-runtime/pkg/cache"</span>
<span class="diff-unchanged">  	"sigs.k8s.io/controller-runtime/pkg/client"</span>
<span class="diff-unchanged">  	"sigs.k8s.io/controller-runtime/pkg/client/fake"</span>
<span class="diff-unchanged">  	"sigs.k8s.io/controller-runtime/pkg/reconcile"</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	apisv1alpha1 "github.com/hwameistor/hwameistor/pkg/apis/hwameistor/v1alpha1"</span>
<span class="diff-unchanged">  	"github.com/hwameistor/hwameistor/pkg/local-storage/member"</span>
<span class="diff-unchanged">  )</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  // SystemMode of HA module</span>
<span class="diff-unchanged">  type SystemMode string</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  var (</span>
<span class="diff-unchanged">  	fakeLocalVolumeName          = "local-volume-example"</span>
<span class="diff-unchanged">  	fakeLocalVolumeUID           = "local-volume-uid"</span>
<span class="diff-unchanged">  	fakeNamespace                = "local-volume-test"</span>
<span class="diff-unchanged">  	fakeNodenames                = []string{"10-6-118-10"}</span>
<span class="diff-unchanged">  	fakeNodename                 = "10-6-118-10"</span>
<span class="diff-unchanged">  	fakeStorageIp                = "10.6.118.11"</span>
<span class="diff-unchanged">  	fakeZone                     = "zone-test"</span>
<span class="diff-unchanged">  	fakeRegion                   = "region-test"</span>
<span class="diff-unchanged">  	fakeVgType                   = "LocalStorage_PoolHDD"</span>
<span class="diff-unchanged">  	fakeVgName                   = "vg-test"</span>
<span class="diff-unchanged">  	fakePoolClass                = "HDD"</span>
<span class="diff-unchanged">  	fakePoolType                 = "REGULAR"</span>
<span class="diff-unchanged">  	fakeTotalCapacityBytes int64 = 10 * 1024 * 1024 * 1024</span>
<span class="diff-unchanged">  	fakeFreeCapacityBytes  int64 = 8 * 1024 * 1024 * 1024</span>
<span class="diff-unchanged">  	fakeDiskCapacityBytes  int64 = 2 * 1024 * 1024 * 1024</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	apiversion      = "hwameistor.io/v1alpha1"</span>
<span class="diff-unchanged">  	LocalVolumeKind = "LocalVolume"</span>
<span class="diff-unchanged">  	fakeRecorder    = record.NewFakeRecorder(100)</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	defaultDRBDStartPort                 = 43001</span>
<span class="diff-unchanged">  	defaultHAVolumeTotalCount            = 1000</span>
<span class="diff-unchanged">  	SystemModeDRBD            SystemMode = "drbd"</span>
<span class="diff-unchanged">  )</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  func TestNewLocalVolumeController(t *testing.T) {</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	systemConfig, err := getSystemConfig()</span>
<span class="diff-unchanged">  	if err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("invalid system config: %s", err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	var ca cache.Cache</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	cli, s := CreateFakeClient()</span>
<span class="diff-unchanged">  	// Create a Reconcile for LocalVolume</span>
<span class="diff-unchanged">  	r := ReconcileLocalVolume{</span>
<span class="diff-unchanged">  		client:        cli,</span>
<span class="diff-unchanged">  		scheme:        s,</span>
<span class="diff-unchanged">  		storageMember: member.Member().ConfigureController(s).ConfigureBase(fakeNodename, fakeNamespace, systemConfig, 0, cli, ca, fakeRecorder).ConfigureNode(s),</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	// Create LocalVolume</span>
<span class="diff-unchanged">  	lv := GenFakeLocalVolumeObject()</span>
<span class="diff-unchanged">  	err = r.client.Create(context.Background(), lv)</span>
<span class="diff-unchanged">  	if err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("Create LocalVolume fail %v", err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	defer r.DeleteFakeLocalVolume(t, lv)</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	// Get lv</span>
<span class="diff-unchanged">  	err = r.client.Get(context.Background(), types.NamespacedName{Namespace: lv.GetNamespace(), Name: lv.GetName()}, lv)</span>
<span class="diff-unchanged">  	if err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("Get lv fail %v", err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	fmt.Printf("lv = %+v", lv)</span>
<span class="diff-unchanged">  	fmt.Printf("r.storageMember = %+v", r.storageMember)</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	// Mock LocalVolume request</span>
<span class="diff-unchanged">  	req := reconcile.Request{NamespacedName: types.NamespacedName{Namespace: lv.GetNamespace(), Name: lv.GetName()}}</span>
<span class="diff-unchanged">  	_, err = r.Reconcile(context.TODO(), req)</span>
<span class="diff-unchanged">  	if err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("Reconcile fail %v", err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  }</span>
<span class="diff-added">+ </span>
<span class="diff-added">+ func TestReconcileLocalVolumeNotFound(t *testing.T) {</span>
<span class="diff-added">+     cli, s := CreateFakeClient()</span>
<span class="diff-added">+     r := ReconcileLocalVolume{</span>
<span class="diff-added">+         client: cli,</span>
<span class="diff-added">+         scheme: s,</span>
<span class="diff-added">+         storageMember: member.Member().ConfigureController(s).ConfigureBase(fakeNodename, fakeNamespace, apisv1alpha1.SystemConfig{}, 0, cli, nil, fakeRecorder).ConfigureNode(s),</span>
<span class="diff-added">+     }</span>
<span class="diff-added">+ </span>
<span class="diff-added">+     req := reconcile.Request{NamespacedName: types.NamespacedName{Namespace: fakeNamespace, Name: "non-existent-volume"}}</span>
<span class="diff-added">+     result, err := r.Reconcile(context.TODO(), req)</span>
<span class="diff-added">+     if err != nil {</span>
<span class="diff-added">+         t.Errorf("Reconcile returned an error: %v", err)</span>
<span class="diff-added">+     }</span>
<span class="diff-added">+     if result.Requeue {</span>
<span class="diff-added">+         t.Errorf("Reconcile unexpectedly requeued the request")</span>
<span class="diff-added">+     }</span>
<span class="diff-added">+ }</span>
<span class="diff-added">+ </span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  // DeleteFakeLocalVolume</span>
<span class="diff-unchanged">  func (r *ReconcileLocalVolume) DeleteFakeLocalVolume(t *testing.T, lv *apisv1alpha1.LocalVolume) {</span>
<span class="diff-unchanged">  	if err := r.client.Delete(context.Background(), lv); err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("Delete LocalVolume %v fail %v", lv.GetName(), err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  // GenFakeLocalVolumeObject Create lv request</span>
<span class="diff-unchanged">  func GenFakeLocalVolumeObject() *apisv1alpha1.LocalVolume {</span>
<span class="diff-unchanged">  	lv := &apisv1alpha1.LocalVolume{}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	TypeMeta := metav1.TypeMeta{</span>
<span class="diff-unchanged">  		Kind:       LocalVolumeKind,</span>
<span class="diff-unchanged">  		APIVersion: apiversion,</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	ObjectMata := metav1.ObjectMeta{</span>
<span class="diff-unchanged">  		Name:              fakeLocalVolumeName,</span>
<span class="diff-unchanged">  		Namespace:         fakeNamespace,</span>
<span class="diff-unchanged">  		ResourceVersion:   "",</span>
<span class="diff-unchanged">  		UID:               types.UID(fakeLocalVolumeUID),</span>
<span class="diff-unchanged">  		CreationTimestamp: metav1.Time{Time: time.Now()},</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	Spec := apisv1alpha1.LocalVolumeSpec{</span>
<span class="diff-unchanged">  		RequiredCapacityBytes: fakeDiskCapacityBytes,</span>
<span class="diff-unchanged">  		ReplicaNumber:         1,</span>
<span class="diff-unchanged">  		PoolName:              fakeVgType,</span>
<span class="diff-unchanged">  		Delete:                false,</span>
<span class="diff-unchanged">  		Convertible:           true,</span>
<span class="diff-unchanged">  		Accessibility: apisv1alpha1.AccessibilityTopology{</span>
<span class="diff-unchanged">  			Nodes:   fakeNodenames,</span>
<span class="diff-unchanged">  			Regions: []string{fakeRegion},</span>
<span class="diff-unchanged">  			Zones:   []string{fakeZone},</span>
<span class="diff-unchanged">  		},</span>
<span class="diff-unchanged">  		Config: &apisv1alpha1.VolumeConfig{</span>
<span class="diff-unchanged">  			Convertible:           true,</span>
<span class="diff-unchanged">  			Initialized:           true,</span>
<span class="diff-unchanged">  			ReadyToInitialize:     true,</span>
<span class="diff-unchanged">  			RequiredCapacityBytes: fakeDiskCapacityBytes,</span>
<span class="diff-unchanged">  			ResourceID:            5,</span>
<span class="diff-unchanged">  			Version:               11,</span>
<span class="diff-unchanged">  			VolumeName:            fakeLocalVolumeName,</span>
<span class="diff-unchanged">  			Replicas: []apisv1alpha1.VolumeReplica{</span>
<span class="diff-unchanged">  				{</span>
<span class="diff-unchanged">  					Hostname: fakeNodename,</span>
<span class="diff-unchanged">  					ID:       1,</span>
<span class="diff-unchanged">  					IP:       fakeStorageIp,</span>
<span class="diff-unchanged">  					Primary:  true,</span>
<span class="diff-unchanged">  				},</span>
<span class="diff-unchanged">  			},</span>
<span class="diff-unchanged">  		},</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	lv.ObjectMeta = ObjectMata</span>
<span class="diff-unchanged">  	lv.TypeMeta = TypeMeta</span>
<span class="diff-unchanged">  	lv.Spec = Spec</span>
<span class="diff-unchanged">  	lv.Status.State = apisv1alpha1.VolumeStateCreating</span>
<span class="diff-unchanged">  	lv.Status.AllocatedCapacityBytes = fakeTotalCapacityBytes - fakeFreeCapacityBytes</span>
<span class="diff-unchanged">  	lv.Status.PublishedNodeName = fakeNodename</span>
<span class="diff-unchanged">  	lv.Status.Replicas = []string{fakeLocalVolumeName}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	return lv</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  // CreateFakeClient Create LocalVolume resource</span>
<span class="diff-unchanged">  func CreateFakeClient() (client.Client, *runtime.Scheme) {</span>
<span class="diff-unchanged">  	lv := GenFakeLocalVolumeObject()</span>
<span class="diff-unchanged">  	lvList := &apisv1alpha1.LocalVolumeList{</span>
<span class="diff-unchanged">  		TypeMeta: metav1.TypeMeta{</span>
<span class="diff-unchanged">  			Kind:       LocalVolumeKind,</span>
<span class="diff-unchanged">  			APIVersion: apiversion,</span>
<span class="diff-unchanged">  		},</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	s := scheme.Scheme</span>
<span class="diff-unchanged">  	s.AddKnownTypes(apisv1alpha1.SchemeGroupVersion, lv)</span>
<span class="diff-unchanged">  	s.AddKnownTypes(apisv1alpha1.SchemeGroupVersion, lvList)</span>
<span class="diff-unchanged">  	return fake.NewClientBuilder().WithScheme(s).Build(), s</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  func validateSystemConfig() error {</span>
<span class="diff-unchanged">  	var errMsgs []string</span>
<span class="diff-unchanged">  	switch apisv1alpha1.SystemMode(SystemModeDRBD) {</span>
<span class="diff-unchanged">  	case apisv1alpha1.SystemModeDRBD:</span>
<span class="diff-unchanged">  	default:</span>
<span class="diff-unchanged">  		errMsgs = append(errMsgs, fmt.Sprintf("system mode %s not supported", SystemModeDRBD))</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	if len(errMsgs) != 0 {</span>
<span class="diff-unchanged">  		return fmt.Errorf(strings.Join(errMsgs, "; "))</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	return nil</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  func getSystemConfig() (apisv1alpha1.SystemConfig, error) {</span>
<span class="diff-unchanged">  	if err := validateSystemConfig(); err != nil {</span>
<span class="diff-unchanged">  		return apisv1alpha1.SystemConfig{}, err</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	config := apisv1alpha1.SystemConfig{</span>
<span class="diff-unchanged">  		Mode:             apisv1alpha1.SystemMode(SystemModeDRBD),</span>
<span class="diff-unchanged">  		MaxHAVolumeCount: defaultHAVolumeTotalCount,</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	switch config.Mode {</span>
<span class="diff-unchanged">  	case apisv1alpha1.SystemModeDRBD:</span>
<span class="diff-unchanged">  		{</span>
<span class="diff-unchanged">  			config.DRBD = &apisv1alpha1.DRBDSystemConfig{</span>
<span class="diff-unchanged">  				StartPort: defaultDRBDStartPort,</span>
<span class="diff-unchanged">  			}</span>
<span class="diff-unchanged">  		}</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	return config, nil</span>
<span class="diff-unchanged">  }</span></code></pre>
                    </details>
                </td>
                <td>
                    <details>
                        <summary>View More</summary>
                        <div><strong>STDERR:</strong> <pre><code class="language-go"></code></pre></div>
                        <div><strong>STDOUT:</strong> <pre><code class="language-go">ok  	github.com/hwameistor/hwameistor/pkg/local-storage/controller/localvolume	0.065s	coverage: 30.8% of statements
</code></pre></div>
                        <div><strong>Test Code:</strong> <pre><code class="language-go">func TestReconcileLocalVolumeNotFound(t *testing.T) {
    cli, s := CreateFakeClient()
    r := ReconcileLocalVolume{
        client: cli,
        scheme: s,
        storageMember: member.Member().ConfigureController(s).ConfigureBase(fakeNodename, fakeNamespace, apisv1alpha1.SystemConfig{}, 0, cli, nil, fakeRecorder).ConfigureNode(s),
    }

    req := reconcile.Request{NamespacedName: types.NamespacedName{Namespace: fakeNamespace, Name: "non-existent-volume"}}
    result, err := r.Reconcile(context.TODO(), req)
    if err != nil {
        t.Errorf("Reconcile returned an error: %v", err)
    }
    if result.Requeue {
        t.Errorf("Reconcile unexpectedly requeued the request")
    }
}
</code></pre></div>
                        <div><strong>Imports:</strong> <pre><code class="language-go">""
</code></pre></div>
                    </details>
                </td>
            </tr>
            
            <tr>
                <td class="status-FAIL">FAIL</td>
                <td>Coverage did not increase. Maybe the test did run but did not increase coverage, or maybe the test execution was skipped due to some problem</td>
                <td>0</td>
                <td>go</td>
                <td>
                    <details>
                        <summary>View Full Code</summary>
                        <pre><code><span class="diff-unchanged">  package localvolume</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  import (</span>
<span class="diff-unchanged">  	"context"</span>
<span class="diff-unchanged">  	"fmt"</span>
<span class="diff-unchanged">  	"strings"</span>
<span class="diff-unchanged">  	"testing"</span>
<span class="diff-unchanged">  	"time"</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"</span>
<span class="diff-unchanged">  	"k8s.io/apimachinery/pkg/runtime"</span>
<span class="diff-unchanged">  	"k8s.io/apimachinery/pkg/types"</span>
<span class="diff-unchanged">  	"k8s.io/client-go/kubernetes/scheme"</span>
<span class="diff-unchanged">  	"k8s.io/client-go/tools/record"</span>
<span class="diff-unchanged">  	"sigs.k8s.io/controller-runtime/pkg/cache"</span>
<span class="diff-unchanged">  	"sigs.k8s.io/controller-runtime/pkg/client"</span>
<span class="diff-unchanged">  	"sigs.k8s.io/controller-runtime/pkg/client/fake"</span>
<span class="diff-unchanged">  	"sigs.k8s.io/controller-runtime/pkg/reconcile"</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	apisv1alpha1 "github.com/hwameistor/hwameistor/pkg/apis/hwameistor/v1alpha1"</span>
<span class="diff-unchanged">  	"github.com/hwameistor/hwameistor/pkg/local-storage/member"</span>
<span class="diff-unchanged">  )</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  // SystemMode of HA module</span>
<span class="diff-unchanged">  type SystemMode string</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  var (</span>
<span class="diff-unchanged">  	fakeLocalVolumeName          = "local-volume-example"</span>
<span class="diff-unchanged">  	fakeLocalVolumeUID           = "local-volume-uid"</span>
<span class="diff-unchanged">  	fakeNamespace                = "local-volume-test"</span>
<span class="diff-unchanged">  	fakeNodenames                = []string{"10-6-118-10"}</span>
<span class="diff-unchanged">  	fakeNodename                 = "10-6-118-10"</span>
<span class="diff-unchanged">  	fakeStorageIp                = "10.6.118.11"</span>
<span class="diff-unchanged">  	fakeZone                     = "zone-test"</span>
<span class="diff-unchanged">  	fakeRegion                   = "region-test"</span>
<span class="diff-unchanged">  	fakeVgType                   = "LocalStorage_PoolHDD"</span>
<span class="diff-unchanged">  	fakeVgName                   = "vg-test"</span>
<span class="diff-unchanged">  	fakePoolClass                = "HDD"</span>
<span class="diff-unchanged">  	fakePoolType                 = "REGULAR"</span>
<span class="diff-unchanged">  	fakeTotalCapacityBytes int64 = 10 * 1024 * 1024 * 1024</span>
<span class="diff-unchanged">  	fakeFreeCapacityBytes  int64 = 8 * 1024 * 1024 * 1024</span>
<span class="diff-unchanged">  	fakeDiskCapacityBytes  int64 = 2 * 1024 * 1024 * 1024</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	apiversion      = "hwameistor.io/v1alpha1"</span>
<span class="diff-unchanged">  	LocalVolumeKind = "LocalVolume"</span>
<span class="diff-unchanged">  	fakeRecorder    = record.NewFakeRecorder(100)</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	defaultDRBDStartPort                 = 43001</span>
<span class="diff-unchanged">  	defaultHAVolumeTotalCount            = 1000</span>
<span class="diff-unchanged">  	SystemModeDRBD            SystemMode = "drbd"</span>
<span class="diff-unchanged">  )</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  func TestNewLocalVolumeController(t *testing.T) {</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	systemConfig, err := getSystemConfig()</span>
<span class="diff-unchanged">  	if err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("invalid system config: %s", err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	var ca cache.Cache</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	cli, s := CreateFakeClient()</span>
<span class="diff-unchanged">  	// Create a Reconcile for LocalVolume</span>
<span class="diff-unchanged">  	r := ReconcileLocalVolume{</span>
<span class="diff-unchanged">  		client:        cli,</span>
<span class="diff-unchanged">  		scheme:        s,</span>
<span class="diff-unchanged">  		storageMember: member.Member().ConfigureController(s).ConfigureBase(fakeNodename, fakeNamespace, systemConfig, 0, cli, ca, fakeRecorder).ConfigureNode(s),</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	// Create LocalVolume</span>
<span class="diff-unchanged">  	lv := GenFakeLocalVolumeObject()</span>
<span class="diff-unchanged">  	err = r.client.Create(context.Background(), lv)</span>
<span class="diff-unchanged">  	if err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("Create LocalVolume fail %v", err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	defer r.DeleteFakeLocalVolume(t, lv)</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	// Get lv</span>
<span class="diff-unchanged">  	err = r.client.Get(context.Background(), types.NamespacedName{Namespace: lv.GetNamespace(), Name: lv.GetName()}, lv)</span>
<span class="diff-unchanged">  	if err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("Get lv fail %v", err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	fmt.Printf("lv = %+v", lv)</span>
<span class="diff-unchanged">  	fmt.Printf("r.storageMember = %+v", r.storageMember)</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	// Mock LocalVolume request</span>
<span class="diff-unchanged">  	req := reconcile.Request{NamespacedName: types.NamespacedName{Namespace: lv.GetNamespace(), Name: lv.GetName()}}</span>
<span class="diff-unchanged">  	_, err = r.Reconcile(context.TODO(), req)</span>
<span class="diff-unchanged">  	if err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("Reconcile fail %v", err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  }</span>
<span class="diff-added">+ </span>
<span class="diff-added">+ func TestReconcileLocalVolumeSuccess(t *testing.T) {</span>
<span class="diff-added">+     cli, s := CreateFakeClient()</span>
<span class="diff-added">+     lv := GenFakeLocalVolumeObject()</span>
<span class="diff-added">+     err := cli.Create(context.Background(), lv)</span>
<span class="diff-added">+     if err != nil {</span>
<span class="diff-added">+         t.Fatalf("Failed to create LocalVolume: %v", err)</span>
<span class="diff-added">+     }</span>
<span class="diff-added">+ </span>
<span class="diff-added">+     r := ReconcileLocalVolume{</span>
<span class="diff-added">+         client: cli,</span>
<span class="diff-added">+         scheme: s,</span>
<span class="diff-added">+         storageMember: member.Member().ConfigureController(s).ConfigureBase(fakeNodename, fakeNamespace, apisv1alpha1.SystemConfig{}, 0, cli, nil, fakeRecorder).ConfigureNode(s),</span>
<span class="diff-added">+     }</span>
<span class="diff-added">+ </span>
<span class="diff-added">+     req := reconcile.Request{NamespacedName: types.NamespacedName{Namespace: lv.GetNamespace(), Name: lv.GetName()}}</span>
<span class="diff-added">+     result, err := r.Reconcile(context.TODO(), req)</span>
<span class="diff-added">+     if err != nil {</span>
<span class="diff-added">+         t.Errorf("Reconcile returned an error: %v", err)</span>
<span class="diff-added">+     }</span>
<span class="diff-added">+     if result.Requeue {</span>
<span class="diff-added">+         t.Errorf("Reconcile unexpectedly requeued the request")</span>
<span class="diff-added">+     }</span>
<span class="diff-added">+ }</span>
<span class="diff-added">+ </span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  func TestReconcileLocalVolumeNotFound(t *testing.T) {</span>
<span class="diff-unchanged">      cli, s := CreateFakeClient()</span>
<span class="diff-unchanged">      r := ReconcileLocalVolume{</span>
<span class="diff-unchanged">          client: cli,</span>
<span class="diff-unchanged">          scheme: s,</span>
<span class="diff-unchanged">          storageMember: member.Member().ConfigureController(s).ConfigureBase(fakeNodename, fakeNamespace, apisv1alpha1.SystemConfig{}, 0, cli, nil, fakeRecorder).ConfigureNode(s),</span>
<span class="diff-unchanged">      }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">      req := reconcile.Request{NamespacedName: types.NamespacedName{Namespace: fakeNamespace, Name: "non-existent-volume"}}</span>
<span class="diff-unchanged">      result, err := r.Reconcile(context.TODO(), req)</span>
<span class="diff-unchanged">      if err != nil {</span>
<span class="diff-unchanged">          t.Errorf("Reconcile returned an error: %v", err)</span>
<span class="diff-unchanged">      }</span>
<span class="diff-unchanged">      if result.Requeue {</span>
<span class="diff-unchanged">          t.Errorf("Reconcile unexpectedly requeued the request")</span>
<span class="diff-unchanged">      }</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  // DeleteFakeLocalVolume</span>
<span class="diff-unchanged">  func (r *ReconcileLocalVolume) DeleteFakeLocalVolume(t *testing.T, lv *apisv1alpha1.LocalVolume) {</span>
<span class="diff-unchanged">  	if err := r.client.Delete(context.Background(), lv); err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("Delete LocalVolume %v fail %v", lv.GetName(), err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  // GenFakeLocalVolumeObject Create lv request</span>
<span class="diff-unchanged">  func GenFakeLocalVolumeObject() *apisv1alpha1.LocalVolume {</span>
<span class="diff-unchanged">  	lv := &apisv1alpha1.LocalVolume{}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	TypeMeta := metav1.TypeMeta{</span>
<span class="diff-unchanged">  		Kind:       LocalVolumeKind,</span>
<span class="diff-unchanged">  		APIVersion: apiversion,</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	ObjectMata := metav1.ObjectMeta{</span>
<span class="diff-unchanged">  		Name:              fakeLocalVolumeName,</span>
<span class="diff-unchanged">  		Namespace:         fakeNamespace,</span>
<span class="diff-unchanged">  		ResourceVersion:   "",</span>
<span class="diff-unchanged">  		UID:               types.UID(fakeLocalVolumeUID),</span>
<span class="diff-unchanged">  		CreationTimestamp: metav1.Time{Time: time.Now()},</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	Spec := apisv1alpha1.LocalVolumeSpec{</span>
<span class="diff-unchanged">  		RequiredCapacityBytes: fakeDiskCapacityBytes,</span>
<span class="diff-unchanged">  		ReplicaNumber:         1,</span>
<span class="diff-unchanged">  		PoolName:              fakeVgType,</span>
<span class="diff-unchanged">  		Delete:                false,</span>
<span class="diff-unchanged">  		Convertible:           true,</span>
<span class="diff-unchanged">  		Accessibility: apisv1alpha1.AccessibilityTopology{</span>
<span class="diff-unchanged">  			Nodes:   fakeNodenames,</span>
<span class="diff-unchanged">  			Regions: []string{fakeRegion},</span>
<span class="diff-unchanged">  			Zones:   []string{fakeZone},</span>
<span class="diff-unchanged">  		},</span>
<span class="diff-unchanged">  		Config: &apisv1alpha1.VolumeConfig{</span>
<span class="diff-unchanged">  			Convertible:           true,</span>
<span class="diff-unchanged">  			Initialized:           true,</span>
<span class="diff-unchanged">  			ReadyToInitialize:     true,</span>
<span class="diff-unchanged">  			RequiredCapacityBytes: fakeDiskCapacityBytes,</span>
<span class="diff-unchanged">  			ResourceID:            5,</span>
<span class="diff-unchanged">  			Version:               11,</span>
<span class="diff-unchanged">  			VolumeName:            fakeLocalVolumeName,</span>
<span class="diff-unchanged">  			Replicas: []apisv1alpha1.VolumeReplica{</span>
<span class="diff-unchanged">  				{</span>
<span class="diff-unchanged">  					Hostname: fakeNodename,</span>
<span class="diff-unchanged">  					ID:       1,</span>
<span class="diff-unchanged">  					IP:       fakeStorageIp,</span>
<span class="diff-unchanged">  					Primary:  true,</span>
<span class="diff-unchanged">  				},</span>
<span class="diff-unchanged">  			},</span>
<span class="diff-unchanged">  		},</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	lv.ObjectMeta = ObjectMata</span>
<span class="diff-unchanged">  	lv.TypeMeta = TypeMeta</span>
<span class="diff-unchanged">  	lv.Spec = Spec</span>
<span class="diff-unchanged">  	lv.Status.State = apisv1alpha1.VolumeStateCreating</span>
<span class="diff-unchanged">  	lv.Status.AllocatedCapacityBytes = fakeTotalCapacityBytes - fakeFreeCapacityBytes</span>
<span class="diff-unchanged">  	lv.Status.PublishedNodeName = fakeNodename</span>
<span class="diff-unchanged">  	lv.Status.Replicas = []string{fakeLocalVolumeName}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	return lv</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  // CreateFakeClient Create LocalVolume resource</span>
<span class="diff-unchanged">  func CreateFakeClient() (client.Client, *runtime.Scheme) {</span>
<span class="diff-unchanged">  	lv := GenFakeLocalVolumeObject()</span>
<span class="diff-unchanged">  	lvList := &apisv1alpha1.LocalVolumeList{</span>
<span class="diff-unchanged">  		TypeMeta: metav1.TypeMeta{</span>
<span class="diff-unchanged">  			Kind:       LocalVolumeKind,</span>
<span class="diff-unchanged">  			APIVersion: apiversion,</span>
<span class="diff-unchanged">  		},</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	s := scheme.Scheme</span>
<span class="diff-unchanged">  	s.AddKnownTypes(apisv1alpha1.SchemeGroupVersion, lv)</span>
<span class="diff-unchanged">  	s.AddKnownTypes(apisv1alpha1.SchemeGroupVersion, lvList)</span>
<span class="diff-unchanged">  	return fake.NewClientBuilder().WithScheme(s).Build(), s</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  func validateSystemConfig() error {</span>
<span class="diff-unchanged">  	var errMsgs []string</span>
<span class="diff-unchanged">  	switch apisv1alpha1.SystemMode(SystemModeDRBD) {</span>
<span class="diff-unchanged">  	case apisv1alpha1.SystemModeDRBD:</span>
<span class="diff-unchanged">  	default:</span>
<span class="diff-unchanged">  		errMsgs = append(errMsgs, fmt.Sprintf("system mode %s not supported", SystemModeDRBD))</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	if len(errMsgs) != 0 {</span>
<span class="diff-unchanged">  		return fmt.Errorf(strings.Join(errMsgs, "; "))</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	return nil</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  func getSystemConfig() (apisv1alpha1.SystemConfig, error) {</span>
<span class="diff-unchanged">  	if err := validateSystemConfig(); err != nil {</span>
<span class="diff-unchanged">  		return apisv1alpha1.SystemConfig{}, err</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	config := apisv1alpha1.SystemConfig{</span>
<span class="diff-unchanged">  		Mode:             apisv1alpha1.SystemMode(SystemModeDRBD),</span>
<span class="diff-unchanged">  		MaxHAVolumeCount: defaultHAVolumeTotalCount,</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	switch config.Mode {</span>
<span class="diff-unchanged">  	case apisv1alpha1.SystemModeDRBD:</span>
<span class="diff-unchanged">  		{</span>
<span class="diff-unchanged">  			config.DRBD = &apisv1alpha1.DRBDSystemConfig{</span>
<span class="diff-unchanged">  				StartPort: defaultDRBDStartPort,</span>
<span class="diff-unchanged">  			}</span>
<span class="diff-unchanged">  		}</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	return config, nil</span>
<span class="diff-unchanged">  }</span></code></pre>
                    </details>
                </td>
                <td>
                    <details>
                        <summary>View More</summary>
                        <div><strong>STDERR:</strong> <pre><code class="language-go"></code></pre></div>
                        <div><strong>STDOUT:</strong> <pre><code class="language-go">ok  	github.com/hwameistor/hwameistor/pkg/local-storage/controller/localvolume	0.062s	coverage: 30.8% of statements
</code></pre></div>
                        <div><strong>Test Code:</strong> <pre><code class="language-go">func TestReconcileLocalVolumeSuccess(t *testing.T) {
    cli, s := CreateFakeClient()
    lv := GenFakeLocalVolumeObject()
    err := cli.Create(context.Background(), lv)
    if err != nil {
        t.Fatalf("Failed to create LocalVolume: %v", err)
    }

    r := ReconcileLocalVolume{
        client: cli,
        scheme: s,
        storageMember: member.Member().ConfigureController(s).ConfigureBase(fakeNodename, fakeNamespace, apisv1alpha1.SystemConfig{}, 0, cli, nil, fakeRecorder).ConfigureNode(s),
    }

    req := reconcile.Request{NamespacedName: types.NamespacedName{Namespace: lv.GetNamespace(), Name: lv.GetName()}}
    result, err := r.Reconcile(context.TODO(), req)
    if err != nil {
        t.Errorf("Reconcile returned an error: %v", err)
    }
    if result.Requeue {
        t.Errorf("Reconcile unexpectedly requeued the request")
    }
}
</code></pre></div>
                        <div><strong>Imports:</strong> <pre><code class="language-go">""
</code></pre></div>
                    </details>
                </td>
            </tr>
            
            <tr>
                <td class="status-FAIL">FAIL</td>
                <td>Test failed</td>
                <td>1</td>
                <td>go</td>
                <td>
                    <details>
                        <summary>View Full Code</summary>
                        <pre><code><span class="diff-unchanged">  package localvolume</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  import (</span>
<span class="diff-unchanged">  	"context"</span>
<span class="diff-unchanged">  	"fmt"</span>
<span class="diff-unchanged">  	"strings"</span>
<span class="diff-unchanged">  	"testing"</span>
<span class="diff-unchanged">  	"time"</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"</span>
<span class="diff-unchanged">  	"k8s.io/apimachinery/pkg/runtime"</span>
<span class="diff-unchanged">  	"k8s.io/apimachinery/pkg/types"</span>
<span class="diff-unchanged">  	"k8s.io/client-go/kubernetes/scheme"</span>
<span class="diff-unchanged">  	"k8s.io/client-go/tools/record"</span>
<span class="diff-unchanged">  	"sigs.k8s.io/controller-runtime/pkg/cache"</span>
<span class="diff-unchanged">  	"sigs.k8s.io/controller-runtime/pkg/client"</span>
<span class="diff-unchanged">  	"sigs.k8s.io/controller-runtime/pkg/client/fake"</span>
<span class="diff-unchanged">  	"sigs.k8s.io/controller-runtime/pkg/reconcile"</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	apisv1alpha1 "github.com/hwameistor/hwameistor/pkg/apis/hwameistor/v1alpha1"</span>
<span class="diff-unchanged">  	"github.com/hwameistor/hwameistor/pkg/local-storage/member"</span>
<span class="diff-unchanged">  )</span>
<span class="diff-added">+ sigs.k8s.io/controller-runtime/pkg/controller</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  // SystemMode of HA module</span>
<span class="diff-unchanged">  type SystemMode string</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  var (</span>
<span class="diff-unchanged">  	fakeLocalVolumeName          = "local-volume-example"</span>
<span class="diff-unchanged">  	fakeLocalVolumeUID           = "local-volume-uid"</span>
<span class="diff-unchanged">  	fakeNamespace                = "local-volume-test"</span>
<span class="diff-unchanged">  	fakeNodenames                = []string{"10-6-118-10"}</span>
<span class="diff-unchanged">  	fakeNodename                 = "10-6-118-10"</span>
<span class="diff-unchanged">  	fakeStorageIp                = "10.6.118.11"</span>
<span class="diff-unchanged">  	fakeZone                     = "zone-test"</span>
<span class="diff-unchanged">  	fakeRegion                   = "region-test"</span>
<span class="diff-unchanged">  	fakeVgType                   = "LocalStorage_PoolHDD"</span>
<span class="diff-unchanged">  	fakeVgName                   = "vg-test"</span>
<span class="diff-unchanged">  	fakePoolClass                = "HDD"</span>
<span class="diff-unchanged">  	fakePoolType                 = "REGULAR"</span>
<span class="diff-unchanged">  	fakeTotalCapacityBytes int64 = 10 * 1024 * 1024 * 1024</span>
<span class="diff-unchanged">  	fakeFreeCapacityBytes  int64 = 8 * 1024 * 1024 * 1024</span>
<span class="diff-unchanged">  	fakeDiskCapacityBytes  int64 = 2 * 1024 * 1024 * 1024</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	apiversion      = "hwameistor.io/v1alpha1"</span>
<span class="diff-unchanged">  	LocalVolumeKind = "LocalVolume"</span>
<span class="diff-unchanged">  	fakeRecorder    = record.NewFakeRecorder(100)</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	defaultDRBDStartPort                 = 43001</span>
<span class="diff-unchanged">  	defaultHAVolumeTotalCount            = 1000</span>
<span class="diff-unchanged">  	SystemModeDRBD            SystemMode = "drbd"</span>
<span class="diff-unchanged">  )</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  func TestNewLocalVolumeController(t *testing.T) {</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	systemConfig, err := getSystemConfig()</span>
<span class="diff-unchanged">  	if err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("invalid system config: %s", err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	var ca cache.Cache</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	cli, s := CreateFakeClient()</span>
<span class="diff-unchanged">  	// Create a Reconcile for LocalVolume</span>
<span class="diff-unchanged">  	r := ReconcileLocalVolume{</span>
<span class="diff-unchanged">  		client:        cli,</span>
<span class="diff-unchanged">  		scheme:        s,</span>
<span class="diff-unchanged">  		storageMember: member.Member().ConfigureController(s).ConfigureBase(fakeNodename, fakeNamespace, systemConfig, 0, cli, ca, fakeRecorder).ConfigureNode(s),</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	// Create LocalVolume</span>
<span class="diff-unchanged">  	lv := GenFakeLocalVolumeObject()</span>
<span class="diff-unchanged">  	err = r.client.Create(context.Background(), lv)</span>
<span class="diff-unchanged">  	if err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("Create LocalVolume fail %v", err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	defer r.DeleteFakeLocalVolume(t, lv)</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	// Get lv</span>
<span class="diff-unchanged">  	err = r.client.Get(context.Background(), types.NamespacedName{Namespace: lv.GetNamespace(), Name: lv.GetName()}, lv)</span>
<span class="diff-unchanged">  	if err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("Get lv fail %v", err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	fmt.Printf("lv = %+v", lv)</span>
<span class="diff-unchanged">  	fmt.Printf("r.storageMember = %+v", r.storageMember)</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	// Mock LocalVolume request</span>
<span class="diff-unchanged">  	req := reconcile.Request{NamespacedName: types.NamespacedName{Namespace: lv.GetNamespace(), Name: lv.GetName()}}</span>
<span class="diff-unchanged">  	_, err = r.Reconcile(context.TODO(), req)</span>
<span class="diff-unchanged">  	if err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("Reconcile fail %v", err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  }</span>
<span class="diff-added">+ </span>
<span class="diff-added">+ func TestAddFunctionControllerCreationFailure(t *testing.T) {</span>
<span class="diff-added">+     cli, s := CreateFakeClient()</span>
<span class="diff-added">+     mgr := &fakeManager{client: cli, scheme: s}</span>
<span class="diff-added">+ </span>
<span class="diff-added">+     // Mock the controller.New function to simulate a failure</span>
<span class="diff-added">+     originalControllerNew := controller.New</span>
<span class="diff-added">+     defer func() { controller.New = originalControllerNew }()</span>
<span class="diff-added">+     controller.New = func(name string, mgr manager.Manager, options controller.Options) (controller.Controller, error) {</span>
<span class="diff-added">+         return nil, fmt.Errorf("mock controller creation failure")</span>
<span class="diff-added">+     }</span>
<span class="diff-added">+ </span>
<span class="diff-added">+     err := Add(mgr)</span>
<span class="diff-added">+     if err == nil {</span>
<span class="diff-added">+         t.Errorf("Expected error when controller creation fails, but got nil")</span>
<span class="diff-added">+     }</span>
<span class="diff-added">+ }</span>
<span class="diff-added">+ </span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  func TestReconcileLocalVolumeNotFound(t *testing.T) {</span>
<span class="diff-unchanged">      cli, s := CreateFakeClient()</span>
<span class="diff-unchanged">      r := ReconcileLocalVolume{</span>
<span class="diff-unchanged">          client: cli,</span>
<span class="diff-unchanged">          scheme: s,</span>
<span class="diff-unchanged">          storageMember: member.Member().ConfigureController(s).ConfigureBase(fakeNodename, fakeNamespace, apisv1alpha1.SystemConfig{}, 0, cli, nil, fakeRecorder).ConfigureNode(s),</span>
<span class="diff-unchanged">      }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">      req := reconcile.Request{NamespacedName: types.NamespacedName{Namespace: fakeNamespace, Name: "non-existent-volume"}}</span>
<span class="diff-unchanged">      result, err := r.Reconcile(context.TODO(), req)</span>
<span class="diff-unchanged">      if err != nil {</span>
<span class="diff-unchanged">          t.Errorf("Reconcile returned an error: %v", err)</span>
<span class="diff-unchanged">      }</span>
<span class="diff-unchanged">      if result.Requeue {</span>
<span class="diff-unchanged">          t.Errorf("Reconcile unexpectedly requeued the request")</span>
<span class="diff-unchanged">      }</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  // DeleteFakeLocalVolume</span>
<span class="diff-unchanged">  func (r *ReconcileLocalVolume) DeleteFakeLocalVolume(t *testing.T, lv *apisv1alpha1.LocalVolume) {</span>
<span class="diff-unchanged">  	if err := r.client.Delete(context.Background(), lv); err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("Delete LocalVolume %v fail %v", lv.GetName(), err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  // GenFakeLocalVolumeObject Create lv request</span>
<span class="diff-unchanged">  func GenFakeLocalVolumeObject() *apisv1alpha1.LocalVolume {</span>
<span class="diff-unchanged">  	lv := &apisv1alpha1.LocalVolume{}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	TypeMeta := metav1.TypeMeta{</span>
<span class="diff-unchanged">  		Kind:       LocalVolumeKind,</span>
<span class="diff-unchanged">  		APIVersion: apiversion,</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	ObjectMata := metav1.ObjectMeta{</span>
<span class="diff-unchanged">  		Name:              fakeLocalVolumeName,</span>
<span class="diff-unchanged">  		Namespace:         fakeNamespace,</span>
<span class="diff-unchanged">  		ResourceVersion:   "",</span>
<span class="diff-unchanged">  		UID:               types.UID(fakeLocalVolumeUID),</span>
<span class="diff-unchanged">  		CreationTimestamp: metav1.Time{Time: time.Now()},</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	Spec := apisv1alpha1.LocalVolumeSpec{</span>
<span class="diff-unchanged">  		RequiredCapacityBytes: fakeDiskCapacityBytes,</span>
<span class="diff-unchanged">  		ReplicaNumber:         1,</span>
<span class="diff-unchanged">  		PoolName:              fakeVgType,</span>
<span class="diff-unchanged">  		Delete:                false,</span>
<span class="diff-unchanged">  		Convertible:           true,</span>
<span class="diff-unchanged">  		Accessibility: apisv1alpha1.AccessibilityTopology{</span>
<span class="diff-unchanged">  			Nodes:   fakeNodenames,</span>
<span class="diff-unchanged">  			Regions: []string{fakeRegion},</span>
<span class="diff-unchanged">  			Zones:   []string{fakeZone},</span>
<span class="diff-unchanged">  		},</span>
<span class="diff-unchanged">  		Config: &apisv1alpha1.VolumeConfig{</span>
<span class="diff-unchanged">  			Convertible:           true,</span>
<span class="diff-unchanged">  			Initialized:           true,</span>
<span class="diff-unchanged">  			ReadyToInitialize:     true,</span>
<span class="diff-unchanged">  			RequiredCapacityBytes: fakeDiskCapacityBytes,</span>
<span class="diff-unchanged">  			ResourceID:            5,</span>
<span class="diff-unchanged">  			Version:               11,</span>
<span class="diff-unchanged">  			VolumeName:            fakeLocalVolumeName,</span>
<span class="diff-unchanged">  			Replicas: []apisv1alpha1.VolumeReplica{</span>
<span class="diff-unchanged">  				{</span>
<span class="diff-unchanged">  					Hostname: fakeNodename,</span>
<span class="diff-unchanged">  					ID:       1,</span>
<span class="diff-unchanged">  					IP:       fakeStorageIp,</span>
<span class="diff-unchanged">  					Primary:  true,</span>
<span class="diff-unchanged">  				},</span>
<span class="diff-unchanged">  			},</span>
<span class="diff-unchanged">  		},</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	lv.ObjectMeta = ObjectMata</span>
<span class="diff-unchanged">  	lv.TypeMeta = TypeMeta</span>
<span class="diff-unchanged">  	lv.Spec = Spec</span>
<span class="diff-unchanged">  	lv.Status.State = apisv1alpha1.VolumeStateCreating</span>
<span class="diff-unchanged">  	lv.Status.AllocatedCapacityBytes = fakeTotalCapacityBytes - fakeFreeCapacityBytes</span>
<span class="diff-unchanged">  	lv.Status.PublishedNodeName = fakeNodename</span>
<span class="diff-unchanged">  	lv.Status.Replicas = []string{fakeLocalVolumeName}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	return lv</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  // CreateFakeClient Create LocalVolume resource</span>
<span class="diff-unchanged">  func CreateFakeClient() (client.Client, *runtime.Scheme) {</span>
<span class="diff-unchanged">  	lv := GenFakeLocalVolumeObject()</span>
<span class="diff-unchanged">  	lvList := &apisv1alpha1.LocalVolumeList{</span>
<span class="diff-unchanged">  		TypeMeta: metav1.TypeMeta{</span>
<span class="diff-unchanged">  			Kind:       LocalVolumeKind,</span>
<span class="diff-unchanged">  			APIVersion: apiversion,</span>
<span class="diff-unchanged">  		},</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	s := scheme.Scheme</span>
<span class="diff-unchanged">  	s.AddKnownTypes(apisv1alpha1.SchemeGroupVersion, lv)</span>
<span class="diff-unchanged">  	s.AddKnownTypes(apisv1alpha1.SchemeGroupVersion, lvList)</span>
<span class="diff-unchanged">  	return fake.NewClientBuilder().WithScheme(s).Build(), s</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  func validateSystemConfig() error {</span>
<span class="diff-unchanged">  	var errMsgs []string</span>
<span class="diff-unchanged">  	switch apisv1alpha1.SystemMode(SystemModeDRBD) {</span>
<span class="diff-unchanged">  	case apisv1alpha1.SystemModeDRBD:</span>
<span class="diff-unchanged">  	default:</span>
<span class="diff-unchanged">  		errMsgs = append(errMsgs, fmt.Sprintf("system mode %s not supported", SystemModeDRBD))</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	if len(errMsgs) != 0 {</span>
<span class="diff-unchanged">  		return fmt.Errorf(strings.Join(errMsgs, "; "))</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	return nil</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  func getSystemConfig() (apisv1alpha1.SystemConfig, error) {</span>
<span class="diff-unchanged">  	if err := validateSystemConfig(); err != nil {</span>
<span class="diff-unchanged">  		return apisv1alpha1.SystemConfig{}, err</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	config := apisv1alpha1.SystemConfig{</span>
<span class="diff-unchanged">  		Mode:             apisv1alpha1.SystemMode(SystemModeDRBD),</span>
<span class="diff-unchanged">  		MaxHAVolumeCount: defaultHAVolumeTotalCount,</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	switch config.Mode {</span>
<span class="diff-unchanged">  	case apisv1alpha1.SystemModeDRBD:</span>
<span class="diff-unchanged">  		{</span>
<span class="diff-unchanged">  			config.DRBD = &apisv1alpha1.DRBDSystemConfig{</span>
<span class="diff-unchanged">  				StartPort: defaultDRBDStartPort,</span>
<span class="diff-unchanged">  			}</span>
<span class="diff-unchanged">  		}</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	return config, nil</span>
<span class="diff-unchanged">  }</span></code></pre>
                    </details>
                </td>
                <td>
                    <details>
                        <summary>View More</summary>
                        <div><strong>STDERR:</strong> <pre><code class="language-go"># github.com/hwameistor/hwameistor/pkg/local-storage/controller/localvolume
pkg/local-storage/controller/localvolume/localvolume_controller_test.go:23:1: expected declaration, found sigs
</code></pre></div>
                        <div><strong>STDOUT:</strong> <pre><code class="language-go">FAIL	github.com/hwameistor/hwameistor/pkg/local-storage/controller/localvolume [setup failed]
FAIL
</code></pre></div>
                        <div><strong>Test Code:</strong> <pre><code class="language-go">func TestAddFunctionControllerCreationFailure(t *testing.T) {
    cli, s := CreateFakeClient()
    mgr := &fakeManager{client: cli, scheme: s}

    // Mock the controller.New function to simulate a failure
    originalControllerNew := controller.New
    defer func() { controller.New = originalControllerNew }()
    controller.New = func(name string, mgr manager.Manager, options controller.Options) (controller.Controller, error) {
        return nil, fmt.Errorf("mock controller creation failure")
    }

    err := Add(mgr)
    if err == nil {
        t.Errorf("Expected error when controller creation fails, but got nil")
    }
}
</code></pre></div>
                        <div><strong>Imports:</strong> <pre><code class="language-go">"sigs.k8s.io/controller-runtime/pkg/controller"
</code></pre></div>
                    </details>
                </td>
            </tr>
            
            <tr>
                <td class="status-FAIL">FAIL</td>
                <td>Test failed</td>
                <td>1</td>
                <td>go</td>
                <td>
                    <details>
                        <summary>View Full Code</summary>
                        <pre><code><span class="diff-unchanged">  package localvolume</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  import (</span>
<span class="diff-unchanged">  	"context"</span>
<span class="diff-unchanged">  	"fmt"</span>
<span class="diff-unchanged">  	"strings"</span>
<span class="diff-unchanged">  	"testing"</span>
<span class="diff-unchanged">  	"time"</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"</span>
<span class="diff-unchanged">  	"k8s.io/apimachinery/pkg/runtime"</span>
<span class="diff-unchanged">  	"k8s.io/apimachinery/pkg/types"</span>
<span class="diff-unchanged">  	"k8s.io/client-go/kubernetes/scheme"</span>
<span class="diff-unchanged">  	"k8s.io/client-go/tools/record"</span>
<span class="diff-unchanged">  	"sigs.k8s.io/controller-runtime/pkg/cache"</span>
<span class="diff-unchanged">  	"sigs.k8s.io/controller-runtime/pkg/client"</span>
<span class="diff-unchanged">  	"sigs.k8s.io/controller-runtime/pkg/client/fake"</span>
<span class="diff-unchanged">  	"sigs.k8s.io/controller-runtime/pkg/reconcile"</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	apisv1alpha1 "github.com/hwameistor/hwameistor/pkg/apis/hwameistor/v1alpha1"</span>
<span class="diff-unchanged">  	"github.com/hwameistor/hwameistor/pkg/local-storage/member"</span>
<span class="diff-unchanged">  )</span>
<span class="diff-added">+ sigs.k8s.io/controller-runtime/pkg/source</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  // SystemMode of HA module</span>
<span class="diff-unchanged">  type SystemMode string</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  var (</span>
<span class="diff-unchanged">  	fakeLocalVolumeName          = "local-volume-example"</span>
<span class="diff-unchanged">  	fakeLocalVolumeUID           = "local-volume-uid"</span>
<span class="diff-unchanged">  	fakeNamespace                = "local-volume-test"</span>
<span class="diff-unchanged">  	fakeNodenames                = []string{"10-6-118-10"}</span>
<span class="diff-unchanged">  	fakeNodename                 = "10-6-118-10"</span>
<span class="diff-unchanged">  	fakeStorageIp                = "10.6.118.11"</span>
<span class="diff-unchanged">  	fakeZone                     = "zone-test"</span>
<span class="diff-unchanged">  	fakeRegion                   = "region-test"</span>
<span class="diff-unchanged">  	fakeVgType                   = "LocalStorage_PoolHDD"</span>
<span class="diff-unchanged">  	fakeVgName                   = "vg-test"</span>
<span class="diff-unchanged">  	fakePoolClass                = "HDD"</span>
<span class="diff-unchanged">  	fakePoolType                 = "REGULAR"</span>
<span class="diff-unchanged">  	fakeTotalCapacityBytes int64 = 10 * 1024 * 1024 * 1024</span>
<span class="diff-unchanged">  	fakeFreeCapacityBytes  int64 = 8 * 1024 * 1024 * 1024</span>
<span class="diff-unchanged">  	fakeDiskCapacityBytes  int64 = 2 * 1024 * 1024 * 1024</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	apiversion      = "hwameistor.io/v1alpha1"</span>
<span class="diff-unchanged">  	LocalVolumeKind = "LocalVolume"</span>
<span class="diff-unchanged">  	fakeRecorder    = record.NewFakeRecorder(100)</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	defaultDRBDStartPort                 = 43001</span>
<span class="diff-unchanged">  	defaultHAVolumeTotalCount            = 1000</span>
<span class="diff-unchanged">  	SystemModeDRBD            SystemMode = "drbd"</span>
<span class="diff-unchanged">  )</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  func TestNewLocalVolumeController(t *testing.T) {</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	systemConfig, err := getSystemConfig()</span>
<span class="diff-unchanged">  	if err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("invalid system config: %s", err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	var ca cache.Cache</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	cli, s := CreateFakeClient()</span>
<span class="diff-unchanged">  	// Create a Reconcile for LocalVolume</span>
<span class="diff-unchanged">  	r := ReconcileLocalVolume{</span>
<span class="diff-unchanged">  		client:        cli,</span>
<span class="diff-unchanged">  		scheme:        s,</span>
<span class="diff-unchanged">  		storageMember: member.Member().ConfigureController(s).ConfigureBase(fakeNodename, fakeNamespace, systemConfig, 0, cli, ca, fakeRecorder).ConfigureNode(s),</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	// Create LocalVolume</span>
<span class="diff-unchanged">  	lv := GenFakeLocalVolumeObject()</span>
<span class="diff-unchanged">  	err = r.client.Create(context.Background(), lv)</span>
<span class="diff-unchanged">  	if err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("Create LocalVolume fail %v", err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	defer r.DeleteFakeLocalVolume(t, lv)</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	// Get lv</span>
<span class="diff-unchanged">  	err = r.client.Get(context.Background(), types.NamespacedName{Namespace: lv.GetNamespace(), Name: lv.GetName()}, lv)</span>
<span class="diff-unchanged">  	if err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("Get lv fail %v", err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	fmt.Printf("lv = %+v", lv)</span>
<span class="diff-unchanged">  	fmt.Printf("r.storageMember = %+v", r.storageMember)</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	// Mock LocalVolume request</span>
<span class="diff-unchanged">  	req := reconcile.Request{NamespacedName: types.NamespacedName{Namespace: lv.GetNamespace(), Name: lv.GetName()}}</span>
<span class="diff-unchanged">  	_, err = r.Reconcile(context.TODO(), req)</span>
<span class="diff-unchanged">  	if err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("Reconcile fail %v", err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  }</span>
<span class="diff-added">+ </span>
<span class="diff-added">+ func TestAddFunctionWatchLocalVolumeFailure(t *testing.T) {</span>
<span class="diff-added">+     cli, s := CreateFakeClient()</span>
<span class="diff-added">+     mgr := &fakeManager{client: cli, scheme: s}</span>
<span class="diff-added">+ </span>
<span class="diff-added">+     // Mock the Watch function to simulate a failure</span>
<span class="diff-added">+     originalWatch := (&source.Kind{}).Watch</span>
<span class="diff-added">+     defer func() { (&source.Kind{}).Watch = originalWatch }()</span>
<span class="diff-added">+     (&source.Kind{}).Watch = func(src source.Source, evthandler handler.EventHandler, predicates ...predicate.Predicate) error {</span>
<span class="diff-added">+         return fmt.Errorf("mock watch failure")</span>
<span class="diff-added">+     }</span>
<span class="diff-added">+ </span>
<span class="diff-added">+     err := Add(mgr)</span>
<span class="diff-added">+     if err == nil {</span>
<span class="diff-added">+         t.Errorf("Expected error when Watch for LocalVolume fails, but got nil")</span>
<span class="diff-added">+     }</span>
<span class="diff-added">+ }</span>
<span class="diff-added">+ </span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  func TestReconcileLocalVolumeNotFound(t *testing.T) {</span>
<span class="diff-unchanged">      cli, s := CreateFakeClient()</span>
<span class="diff-unchanged">      r := ReconcileLocalVolume{</span>
<span class="diff-unchanged">          client: cli,</span>
<span class="diff-unchanged">          scheme: s,</span>
<span class="diff-unchanged">          storageMember: member.Member().ConfigureController(s).ConfigureBase(fakeNodename, fakeNamespace, apisv1alpha1.SystemConfig{}, 0, cli, nil, fakeRecorder).ConfigureNode(s),</span>
<span class="diff-unchanged">      }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">      req := reconcile.Request{NamespacedName: types.NamespacedName{Namespace: fakeNamespace, Name: "non-existent-volume"}}</span>
<span class="diff-unchanged">      result, err := r.Reconcile(context.TODO(), req)</span>
<span class="diff-unchanged">      if err != nil {</span>
<span class="diff-unchanged">          t.Errorf("Reconcile returned an error: %v", err)</span>
<span class="diff-unchanged">      }</span>
<span class="diff-unchanged">      if result.Requeue {</span>
<span class="diff-unchanged">          t.Errorf("Reconcile unexpectedly requeued the request")</span>
<span class="diff-unchanged">      }</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  // DeleteFakeLocalVolume</span>
<span class="diff-unchanged">  func (r *ReconcileLocalVolume) DeleteFakeLocalVolume(t *testing.T, lv *apisv1alpha1.LocalVolume) {</span>
<span class="diff-unchanged">  	if err := r.client.Delete(context.Background(), lv); err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("Delete LocalVolume %v fail %v", lv.GetName(), err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  // GenFakeLocalVolumeObject Create lv request</span>
<span class="diff-unchanged">  func GenFakeLocalVolumeObject() *apisv1alpha1.LocalVolume {</span>
<span class="diff-unchanged">  	lv := &apisv1alpha1.LocalVolume{}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	TypeMeta := metav1.TypeMeta{</span>
<span class="diff-unchanged">  		Kind:       LocalVolumeKind,</span>
<span class="diff-unchanged">  		APIVersion: apiversion,</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	ObjectMata := metav1.ObjectMeta{</span>
<span class="diff-unchanged">  		Name:              fakeLocalVolumeName,</span>
<span class="diff-unchanged">  		Namespace:         fakeNamespace,</span>
<span class="diff-unchanged">  		ResourceVersion:   "",</span>
<span class="diff-unchanged">  		UID:               types.UID(fakeLocalVolumeUID),</span>
<span class="diff-unchanged">  		CreationTimestamp: metav1.Time{Time: time.Now()},</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	Spec := apisv1alpha1.LocalVolumeSpec{</span>
<span class="diff-unchanged">  		RequiredCapacityBytes: fakeDiskCapacityBytes,</span>
<span class="diff-unchanged">  		ReplicaNumber:         1,</span>
<span class="diff-unchanged">  		PoolName:              fakeVgType,</span>
<span class="diff-unchanged">  		Delete:                false,</span>
<span class="diff-unchanged">  		Convertible:           true,</span>
<span class="diff-unchanged">  		Accessibility: apisv1alpha1.AccessibilityTopology{</span>
<span class="diff-unchanged">  			Nodes:   fakeNodenames,</span>
<span class="diff-unchanged">  			Regions: []string{fakeRegion},</span>
<span class="diff-unchanged">  			Zones:   []string{fakeZone},</span>
<span class="diff-unchanged">  		},</span>
<span class="diff-unchanged">  		Config: &apisv1alpha1.VolumeConfig{</span>
<span class="diff-unchanged">  			Convertible:           true,</span>
<span class="diff-unchanged">  			Initialized:           true,</span>
<span class="diff-unchanged">  			ReadyToInitialize:     true,</span>
<span class="diff-unchanged">  			RequiredCapacityBytes: fakeDiskCapacityBytes,</span>
<span class="diff-unchanged">  			ResourceID:            5,</span>
<span class="diff-unchanged">  			Version:               11,</span>
<span class="diff-unchanged">  			VolumeName:            fakeLocalVolumeName,</span>
<span class="diff-unchanged">  			Replicas: []apisv1alpha1.VolumeReplica{</span>
<span class="diff-unchanged">  				{</span>
<span class="diff-unchanged">  					Hostname: fakeNodename,</span>
<span class="diff-unchanged">  					ID:       1,</span>
<span class="diff-unchanged">  					IP:       fakeStorageIp,</span>
<span class="diff-unchanged">  					Primary:  true,</span>
<span class="diff-unchanged">  				},</span>
<span class="diff-unchanged">  			},</span>
<span class="diff-unchanged">  		},</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	lv.ObjectMeta = ObjectMata</span>
<span class="diff-unchanged">  	lv.TypeMeta = TypeMeta</span>
<span class="diff-unchanged">  	lv.Spec = Spec</span>
<span class="diff-unchanged">  	lv.Status.State = apisv1alpha1.VolumeStateCreating</span>
<span class="diff-unchanged">  	lv.Status.AllocatedCapacityBytes = fakeTotalCapacityBytes - fakeFreeCapacityBytes</span>
<span class="diff-unchanged">  	lv.Status.PublishedNodeName = fakeNodename</span>
<span class="diff-unchanged">  	lv.Status.Replicas = []string{fakeLocalVolumeName}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	return lv</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  // CreateFakeClient Create LocalVolume resource</span>
<span class="diff-unchanged">  func CreateFakeClient() (client.Client, *runtime.Scheme) {</span>
<span class="diff-unchanged">  	lv := GenFakeLocalVolumeObject()</span>
<span class="diff-unchanged">  	lvList := &apisv1alpha1.LocalVolumeList{</span>
<span class="diff-unchanged">  		TypeMeta: metav1.TypeMeta{</span>
<span class="diff-unchanged">  			Kind:       LocalVolumeKind,</span>
<span class="diff-unchanged">  			APIVersion: apiversion,</span>
<span class="diff-unchanged">  		},</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	s := scheme.Scheme</span>
<span class="diff-unchanged">  	s.AddKnownTypes(apisv1alpha1.SchemeGroupVersion, lv)</span>
<span class="diff-unchanged">  	s.AddKnownTypes(apisv1alpha1.SchemeGroupVersion, lvList)</span>
<span class="diff-unchanged">  	return fake.NewClientBuilder().WithScheme(s).Build(), s</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  func validateSystemConfig() error {</span>
<span class="diff-unchanged">  	var errMsgs []string</span>
<span class="diff-unchanged">  	switch apisv1alpha1.SystemMode(SystemModeDRBD) {</span>
<span class="diff-unchanged">  	case apisv1alpha1.SystemModeDRBD:</span>
<span class="diff-unchanged">  	default:</span>
<span class="diff-unchanged">  		errMsgs = append(errMsgs, fmt.Sprintf("system mode %s not supported", SystemModeDRBD))</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	if len(errMsgs) != 0 {</span>
<span class="diff-unchanged">  		return fmt.Errorf(strings.Join(errMsgs, "; "))</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	return nil</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  func getSystemConfig() (apisv1alpha1.SystemConfig, error) {</span>
<span class="diff-unchanged">  	if err := validateSystemConfig(); err != nil {</span>
<span class="diff-unchanged">  		return apisv1alpha1.SystemConfig{}, err</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	config := apisv1alpha1.SystemConfig{</span>
<span class="diff-unchanged">  		Mode:             apisv1alpha1.SystemMode(SystemModeDRBD),</span>
<span class="diff-unchanged">  		MaxHAVolumeCount: defaultHAVolumeTotalCount,</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	switch config.Mode {</span>
<span class="diff-unchanged">  	case apisv1alpha1.SystemModeDRBD:</span>
<span class="diff-unchanged">  		{</span>
<span class="diff-unchanged">  			config.DRBD = &apisv1alpha1.DRBDSystemConfig{</span>
<span class="diff-unchanged">  				StartPort: defaultDRBDStartPort,</span>
<span class="diff-unchanged">  			}</span>
<span class="diff-unchanged">  		}</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	return config, nil</span>
<span class="diff-unchanged">  }</span></code></pre>
                    </details>
                </td>
                <td>
                    <details>
                        <summary>View More</summary>
                        <div><strong>STDERR:</strong> <pre><code class="language-go"># github.com/hwameistor/hwameistor/pkg/local-storage/controller/localvolume
pkg/local-storage/controller/localvolume/localvolume_controller_test.go:23:1: expected declaration, found sigs
</code></pre></div>
                        <div><strong>STDOUT:</strong> <pre><code class="language-go">FAIL	github.com/hwameistor/hwameistor/pkg/local-storage/controller/localvolume [setup failed]
FAIL
</code></pre></div>
                        <div><strong>Test Code:</strong> <pre><code class="language-go">func TestAddFunctionWatchLocalVolumeFailure(t *testing.T) {
    cli, s := CreateFakeClient()
    mgr := &fakeManager{client: cli, scheme: s}

    // Mock the Watch function to simulate a failure
    originalWatch := (&source.Kind{}).Watch
    defer func() { (&source.Kind{}).Watch = originalWatch }()
    (&source.Kind{}).Watch = func(src source.Source, evthandler handler.EventHandler, predicates ...predicate.Predicate) error {
        return fmt.Errorf("mock watch failure")
    }

    err := Add(mgr)
    if err == nil {
        t.Errorf("Expected error when Watch for LocalVolume fails, but got nil")
    }
}
</code></pre></div>
                        <div><strong>Imports:</strong> <pre><code class="language-go">"sigs.k8s.io/controller-runtime/pkg/source"
</code></pre></div>
                    </details>
                </td>
            </tr>
            
            <tr>
                <td class="status-FAIL">FAIL</td>
                <td>Test failed</td>
                <td>2</td>
                <td>go</td>
                <td>
                    <details>
                        <summary>View Full Code</summary>
                        <pre><code><span class="diff-unchanged">  package localvolume</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  import (</span>
<span class="diff-unchanged">  	"context"</span>
<span class="diff-unchanged">  	"fmt"</span>
<span class="diff-unchanged">  	"strings"</span>
<span class="diff-unchanged">  	"testing"</span>
<span class="diff-unchanged">  	"time"</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"</span>
<span class="diff-unchanged">  	"k8s.io/apimachinery/pkg/runtime"</span>
<span class="diff-unchanged">  	"k8s.io/apimachinery/pkg/types"</span>
<span class="diff-unchanged">  	"k8s.io/client-go/kubernetes/scheme"</span>
<span class="diff-unchanged">  	"k8s.io/client-go/tools/record"</span>
<span class="diff-unchanged">  	"sigs.k8s.io/controller-runtime/pkg/cache"</span>
<span class="diff-unchanged">  	"sigs.k8s.io/controller-runtime/pkg/client"</span>
<span class="diff-unchanged">  	"sigs.k8s.io/controller-runtime/pkg/client/fake"</span>
<span class="diff-unchanged">  	"sigs.k8s.io/controller-runtime/pkg/reconcile"</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	apisv1alpha1 "github.com/hwameistor/hwameistor/pkg/apis/hwameistor/v1alpha1"</span>
<span class="diff-unchanged">  	"github.com/hwameistor/hwameistor/pkg/local-storage/member"</span>
<span class="diff-unchanged">  )</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  // SystemMode of HA module</span>
<span class="diff-unchanged">  type SystemMode string</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  var (</span>
<span class="diff-unchanged">  	fakeLocalVolumeName          = "local-volume-example"</span>
<span class="diff-unchanged">  	fakeLocalVolumeUID           = "local-volume-uid"</span>
<span class="diff-unchanged">  	fakeNamespace                = "local-volume-test"</span>
<span class="diff-unchanged">  	fakeNodenames                = []string{"10-6-118-10"}</span>
<span class="diff-unchanged">  	fakeNodename                 = "10-6-118-10"</span>
<span class="diff-unchanged">  	fakeStorageIp                = "10.6.118.11"</span>
<span class="diff-unchanged">  	fakeZone                     = "zone-test"</span>
<span class="diff-unchanged">  	fakeRegion                   = "region-test"</span>
<span class="diff-unchanged">  	fakeVgType                   = "LocalStorage_PoolHDD"</span>
<span class="diff-unchanged">  	fakeVgName                   = "vg-test"</span>
<span class="diff-unchanged">  	fakePoolClass                = "HDD"</span>
<span class="diff-unchanged">  	fakePoolType                 = "REGULAR"</span>
<span class="diff-unchanged">  	fakeTotalCapacityBytes int64 = 10 * 1024 * 1024 * 1024</span>
<span class="diff-unchanged">  	fakeFreeCapacityBytes  int64 = 8 * 1024 * 1024 * 1024</span>
<span class="diff-unchanged">  	fakeDiskCapacityBytes  int64 = 2 * 1024 * 1024 * 1024</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	apiversion      = "hwameistor.io/v1alpha1"</span>
<span class="diff-unchanged">  	LocalVolumeKind = "LocalVolume"</span>
<span class="diff-unchanged">  	fakeRecorder    = record.NewFakeRecorder(100)</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	defaultDRBDStartPort                 = 43001</span>
<span class="diff-unchanged">  	defaultHAVolumeTotalCount            = 1000</span>
<span class="diff-unchanged">  	SystemModeDRBD            SystemMode = "drbd"</span>
<span class="diff-unchanged">  )</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  func TestNewLocalVolumeController(t *testing.T) {</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	systemConfig, err := getSystemConfig()</span>
<span class="diff-unchanged">  	if err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("invalid system config: %s", err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	var ca cache.Cache</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	cli, s := CreateFakeClient()</span>
<span class="diff-unchanged">  	// Create a Reconcile for LocalVolume</span>
<span class="diff-unchanged">  	r := ReconcileLocalVolume{</span>
<span class="diff-unchanged">  		client:        cli,</span>
<span class="diff-unchanged">  		scheme:        s,</span>
<span class="diff-unchanged">  		storageMember: member.Member().ConfigureController(s).ConfigureBase(fakeNodename, fakeNamespace, systemConfig, 0, cli, ca, fakeRecorder).ConfigureNode(s),</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	// Create LocalVolume</span>
<span class="diff-unchanged">  	lv := GenFakeLocalVolumeObject()</span>
<span class="diff-unchanged">  	err = r.client.Create(context.Background(), lv)</span>
<span class="diff-unchanged">  	if err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("Create LocalVolume fail %v", err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	defer r.DeleteFakeLocalVolume(t, lv)</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	// Get lv</span>
<span class="diff-unchanged">  	err = r.client.Get(context.Background(), types.NamespacedName{Namespace: lv.GetNamespace(), Name: lv.GetName()}, lv)</span>
<span class="diff-unchanged">  	if err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("Get lv fail %v", err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	fmt.Printf("lv = %+v", lv)</span>
<span class="diff-unchanged">  	fmt.Printf("r.storageMember = %+v", r.storageMember)</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	// Mock LocalVolume request</span>
<span class="diff-unchanged">  	req := reconcile.Request{NamespacedName: types.NamespacedName{Namespace: lv.GetNamespace(), Name: lv.GetName()}}</span>
<span class="diff-unchanged">  	_, err = r.Reconcile(context.TODO(), req)</span>
<span class="diff-unchanged">  	if err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("Reconcile fail %v", err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  }</span>
<span class="diff-added">+ </span>
<span class="diff-added">+ func TestReconcileLocalVolumeNotFound(t *testing.T) {</span>
<span class="diff-added">+     cli, s := CreateFakeClient()</span>
<span class="diff-added">+ </span>
<span class="diff-added">+     r := ReconcileLocalVolume{</span>
<span class="diff-added">+         client:        cli,</span>
<span class="diff-added">+         scheme:        s,</span>
<span class="diff-added">+         storageMember: member.Member(),</span>
<span class="diff-added">+     }</span>
<span class="diff-added">+ </span>
<span class="diff-added">+     req := reconcile.Request{NamespacedName: types.NamespacedName{Namespace: "nonexistent-namespace", Name: "nonexistent-name"}}</span>
<span class="diff-added">+     result, err := r.Reconcile(context.TODO(), req)</span>
<span class="diff-added">+     if err != nil {</span>
<span class="diff-added">+         t.Errorf("Reconcile returned an error: %v", err)</span>
<span class="diff-added">+     }</span>
<span class="diff-added">+     if result.Requeue {</span>
<span class="diff-added">+         t.Errorf("Reconcile unexpectedly requeued the request for a non-existent object")</span>
<span class="diff-added">+     }</span>
<span class="diff-added">+ }</span>
<span class="diff-added">+ </span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  func TestReconcileLocalVolumeNotFound(t *testing.T) {</span>
<span class="diff-unchanged">      cli, s := CreateFakeClient()</span>
<span class="diff-unchanged">      r := ReconcileLocalVolume{</span>
<span class="diff-unchanged">          client: cli,</span>
<span class="diff-unchanged">          scheme: s,</span>
<span class="diff-unchanged">          storageMember: member.Member().ConfigureController(s).ConfigureBase(fakeNodename, fakeNamespace, apisv1alpha1.SystemConfig{}, 0, cli, nil, fakeRecorder).ConfigureNode(s),</span>
<span class="diff-unchanged">      }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">      req := reconcile.Request{NamespacedName: types.NamespacedName{Namespace: fakeNamespace, Name: "non-existent-volume"}}</span>
<span class="diff-unchanged">      result, err := r.Reconcile(context.TODO(), req)</span>
<span class="diff-unchanged">      if err != nil {</span>
<span class="diff-unchanged">          t.Errorf("Reconcile returned an error: %v", err)</span>
<span class="diff-unchanged">      }</span>
<span class="diff-unchanged">      if result.Requeue {</span>
<span class="diff-unchanged">          t.Errorf("Reconcile unexpectedly requeued the request")</span>
<span class="diff-unchanged">      }</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  // DeleteFakeLocalVolume</span>
<span class="diff-unchanged">  func (r *ReconcileLocalVolume) DeleteFakeLocalVolume(t *testing.T, lv *apisv1alpha1.LocalVolume) {</span>
<span class="diff-unchanged">  	if err := r.client.Delete(context.Background(), lv); err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("Delete LocalVolume %v fail %v", lv.GetName(), err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  // GenFakeLocalVolumeObject Create lv request</span>
<span class="diff-unchanged">  func GenFakeLocalVolumeObject() *apisv1alpha1.LocalVolume {</span>
<span class="diff-unchanged">  	lv := &apisv1alpha1.LocalVolume{}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	TypeMeta := metav1.TypeMeta{</span>
<span class="diff-unchanged">  		Kind:       LocalVolumeKind,</span>
<span class="diff-unchanged">  		APIVersion: apiversion,</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	ObjectMata := metav1.ObjectMeta{</span>
<span class="diff-unchanged">  		Name:              fakeLocalVolumeName,</span>
<span class="diff-unchanged">  		Namespace:         fakeNamespace,</span>
<span class="diff-unchanged">  		ResourceVersion:   "",</span>
<span class="diff-unchanged">  		UID:               types.UID(fakeLocalVolumeUID),</span>
<span class="diff-unchanged">  		CreationTimestamp: metav1.Time{Time: time.Now()},</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	Spec := apisv1alpha1.LocalVolumeSpec{</span>
<span class="diff-unchanged">  		RequiredCapacityBytes: fakeDiskCapacityBytes,</span>
<span class="diff-unchanged">  		ReplicaNumber:         1,</span>
<span class="diff-unchanged">  		PoolName:              fakeVgType,</span>
<span class="diff-unchanged">  		Delete:                false,</span>
<span class="diff-unchanged">  		Convertible:           true,</span>
<span class="diff-unchanged">  		Accessibility: apisv1alpha1.AccessibilityTopology{</span>
<span class="diff-unchanged">  			Nodes:   fakeNodenames,</span>
<span class="diff-unchanged">  			Regions: []string{fakeRegion},</span>
<span class="diff-unchanged">  			Zones:   []string{fakeZone},</span>
<span class="diff-unchanged">  		},</span>
<span class="diff-unchanged">  		Config: &apisv1alpha1.VolumeConfig{</span>
<span class="diff-unchanged">  			Convertible:           true,</span>
<span class="diff-unchanged">  			Initialized:           true,</span>
<span class="diff-unchanged">  			ReadyToInitialize:     true,</span>
<span class="diff-unchanged">  			RequiredCapacityBytes: fakeDiskCapacityBytes,</span>
<span class="diff-unchanged">  			ResourceID:            5,</span>
<span class="diff-unchanged">  			Version:               11,</span>
<span class="diff-unchanged">  			VolumeName:            fakeLocalVolumeName,</span>
<span class="diff-unchanged">  			Replicas: []apisv1alpha1.VolumeReplica{</span>
<span class="diff-unchanged">  				{</span>
<span class="diff-unchanged">  					Hostname: fakeNodename,</span>
<span class="diff-unchanged">  					ID:       1,</span>
<span class="diff-unchanged">  					IP:       fakeStorageIp,</span>
<span class="diff-unchanged">  					Primary:  true,</span>
<span class="diff-unchanged">  				},</span>
<span class="diff-unchanged">  			},</span>
<span class="diff-unchanged">  		},</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	lv.ObjectMeta = ObjectMata</span>
<span class="diff-unchanged">  	lv.TypeMeta = TypeMeta</span>
<span class="diff-unchanged">  	lv.Spec = Spec</span>
<span class="diff-unchanged">  	lv.Status.State = apisv1alpha1.VolumeStateCreating</span>
<span class="diff-unchanged">  	lv.Status.AllocatedCapacityBytes = fakeTotalCapacityBytes - fakeFreeCapacityBytes</span>
<span class="diff-unchanged">  	lv.Status.PublishedNodeName = fakeNodename</span>
<span class="diff-unchanged">  	lv.Status.Replicas = []string{fakeLocalVolumeName}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	return lv</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  // CreateFakeClient Create LocalVolume resource</span>
<span class="diff-unchanged">  func CreateFakeClient() (client.Client, *runtime.Scheme) {</span>
<span class="diff-unchanged">  	lv := GenFakeLocalVolumeObject()</span>
<span class="diff-unchanged">  	lvList := &apisv1alpha1.LocalVolumeList{</span>
<span class="diff-unchanged">  		TypeMeta: metav1.TypeMeta{</span>
<span class="diff-unchanged">  			Kind:       LocalVolumeKind,</span>
<span class="diff-unchanged">  			APIVersion: apiversion,</span>
<span class="diff-unchanged">  		},</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	s := scheme.Scheme</span>
<span class="diff-unchanged">  	s.AddKnownTypes(apisv1alpha1.SchemeGroupVersion, lv)</span>
<span class="diff-unchanged">  	s.AddKnownTypes(apisv1alpha1.SchemeGroupVersion, lvList)</span>
<span class="diff-unchanged">  	return fake.NewClientBuilder().WithScheme(s).Build(), s</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  func validateSystemConfig() error {</span>
<span class="diff-unchanged">  	var errMsgs []string</span>
<span class="diff-unchanged">  	switch apisv1alpha1.SystemMode(SystemModeDRBD) {</span>
<span class="diff-unchanged">  	case apisv1alpha1.SystemModeDRBD:</span>
<span class="diff-unchanged">  	default:</span>
<span class="diff-unchanged">  		errMsgs = append(errMsgs, fmt.Sprintf("system mode %s not supported", SystemModeDRBD))</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	if len(errMsgs) != 0 {</span>
<span class="diff-unchanged">  		return fmt.Errorf(strings.Join(errMsgs, "; "))</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	return nil</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  func getSystemConfig() (apisv1alpha1.SystemConfig, error) {</span>
<span class="diff-unchanged">  	if err := validateSystemConfig(); err != nil {</span>
<span class="diff-unchanged">  		return apisv1alpha1.SystemConfig{}, err</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	config := apisv1alpha1.SystemConfig{</span>
<span class="diff-unchanged">  		Mode:             apisv1alpha1.SystemMode(SystemModeDRBD),</span>
<span class="diff-unchanged">  		MaxHAVolumeCount: defaultHAVolumeTotalCount,</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	switch config.Mode {</span>
<span class="diff-unchanged">  	case apisv1alpha1.SystemModeDRBD:</span>
<span class="diff-unchanged">  		{</span>
<span class="diff-unchanged">  			config.DRBD = &apisv1alpha1.DRBDSystemConfig{</span>
<span class="diff-unchanged">  				StartPort: defaultDRBDStartPort,</span>
<span class="diff-unchanged">  			}</span>
<span class="diff-unchanged">  		}</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	return config, nil</span>
<span class="diff-unchanged">  }</span></code></pre>
                    </details>
                </td>
                <td>
                    <details>
                        <summary>View More</summary>
                        <div><strong>STDERR:</strong> <pre><code class="language-go"># github.com/hwameistor/hwameistor/pkg/local-storage/controller/localvolume [github.com/hwameistor/hwameistor/pkg/local-storage/controller/localvolume.test]
pkg/local-storage/controller/localvolume/localvolume_controller_test.go:114:6: TestReconcileLocalVolumeNotFound redeclared in this block
	pkg/local-storage/controller/localvolume/localvolume_controller_test.go:94:6: other declaration of TestReconcileLocalVolumeNotFound
note: module requires Go 1.21
</code></pre></div>
                        <div><strong>STDOUT:</strong> <pre><code class="language-go">FAIL	github.com/hwameistor/hwameistor/pkg/local-storage/controller/localvolume [build failed]
FAIL
</code></pre></div>
                        <div><strong>Test Code:</strong> <pre><code class="language-go">func TestReconcileLocalVolumeNotFound(t *testing.T) {
    cli, s := CreateFakeClient()

    r := ReconcileLocalVolume{
        client:        cli,
        scheme:        s,
        storageMember: member.Member(),
    }

    req := reconcile.Request{NamespacedName: types.NamespacedName{Namespace: "nonexistent-namespace", Name: "nonexistent-name"}}
    result, err := r.Reconcile(context.TODO(), req)
    if err != nil {
        t.Errorf("Reconcile returned an error: %v", err)
    }
    if result.Requeue {
        t.Errorf("Reconcile unexpectedly requeued the request for a non-existent object")
    }
}
</code></pre></div>
                        <div><strong>Imports:</strong> <pre><code class="language-go">""
</code></pre></div>
                    </details>
                </td>
            </tr>
            
            <tr>
                <td class="status-FAIL">FAIL</td>
                <td>Coverage did not increase. Maybe the test did run but did not increase coverage, or maybe the test execution was skipped due to some problem</td>
                <td>0</td>
                <td>go</td>
                <td>
                    <details>
                        <summary>View Full Code</summary>
                        <pre><code><span class="diff-unchanged">  package localvolume</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  import (</span>
<span class="diff-unchanged">  	"context"</span>
<span class="diff-unchanged">  	"fmt"</span>
<span class="diff-unchanged">  	"strings"</span>
<span class="diff-unchanged">  	"testing"</span>
<span class="diff-unchanged">  	"time"</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"</span>
<span class="diff-unchanged">  	"k8s.io/apimachinery/pkg/runtime"</span>
<span class="diff-unchanged">  	"k8s.io/apimachinery/pkg/types"</span>
<span class="diff-unchanged">  	"k8s.io/client-go/kubernetes/scheme"</span>
<span class="diff-unchanged">  	"k8s.io/client-go/tools/record"</span>
<span class="diff-unchanged">  	"sigs.k8s.io/controller-runtime/pkg/cache"</span>
<span class="diff-unchanged">  	"sigs.k8s.io/controller-runtime/pkg/client"</span>
<span class="diff-unchanged">  	"sigs.k8s.io/controller-runtime/pkg/client/fake"</span>
<span class="diff-unchanged">  	"sigs.k8s.io/controller-runtime/pkg/reconcile"</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	apisv1alpha1 "github.com/hwameistor/hwameistor/pkg/apis/hwameistor/v1alpha1"</span>
<span class="diff-unchanged">  	"github.com/hwameistor/hwameistor/pkg/local-storage/member"</span>
<span class="diff-unchanged">  )</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  // SystemMode of HA module</span>
<span class="diff-unchanged">  type SystemMode string</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  var (</span>
<span class="diff-unchanged">  	fakeLocalVolumeName          = "local-volume-example"</span>
<span class="diff-unchanged">  	fakeLocalVolumeUID           = "local-volume-uid"</span>
<span class="diff-unchanged">  	fakeNamespace                = "local-volume-test"</span>
<span class="diff-unchanged">  	fakeNodenames                = []string{"10-6-118-10"}</span>
<span class="diff-unchanged">  	fakeNodename                 = "10-6-118-10"</span>
<span class="diff-unchanged">  	fakeStorageIp                = "10.6.118.11"</span>
<span class="diff-unchanged">  	fakeZone                     = "zone-test"</span>
<span class="diff-unchanged">  	fakeRegion                   = "region-test"</span>
<span class="diff-unchanged">  	fakeVgType                   = "LocalStorage_PoolHDD"</span>
<span class="diff-unchanged">  	fakeVgName                   = "vg-test"</span>
<span class="diff-unchanged">  	fakePoolClass                = "HDD"</span>
<span class="diff-unchanged">  	fakePoolType                 = "REGULAR"</span>
<span class="diff-unchanged">  	fakeTotalCapacityBytes int64 = 10 * 1024 * 1024 * 1024</span>
<span class="diff-unchanged">  	fakeFreeCapacityBytes  int64 = 8 * 1024 * 1024 * 1024</span>
<span class="diff-unchanged">  	fakeDiskCapacityBytes  int64 = 2 * 1024 * 1024 * 1024</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	apiversion      = "hwameistor.io/v1alpha1"</span>
<span class="diff-unchanged">  	LocalVolumeKind = "LocalVolume"</span>
<span class="diff-unchanged">  	fakeRecorder    = record.NewFakeRecorder(100)</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	defaultDRBDStartPort                 = 43001</span>
<span class="diff-unchanged">  	defaultHAVolumeTotalCount            = 1000</span>
<span class="diff-unchanged">  	SystemModeDRBD            SystemMode = "drbd"</span>
<span class="diff-unchanged">  )</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  func TestNewLocalVolumeController(t *testing.T) {</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	systemConfig, err := getSystemConfig()</span>
<span class="diff-unchanged">  	if err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("invalid system config: %s", err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	var ca cache.Cache</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	cli, s := CreateFakeClient()</span>
<span class="diff-unchanged">  	// Create a Reconcile for LocalVolume</span>
<span class="diff-unchanged">  	r := ReconcileLocalVolume{</span>
<span class="diff-unchanged">  		client:        cli,</span>
<span class="diff-unchanged">  		scheme:        s,</span>
<span class="diff-unchanged">  		storageMember: member.Member().ConfigureController(s).ConfigureBase(fakeNodename, fakeNamespace, systemConfig, 0, cli, ca, fakeRecorder).ConfigureNode(s),</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	// Create LocalVolume</span>
<span class="diff-unchanged">  	lv := GenFakeLocalVolumeObject()</span>
<span class="diff-unchanged">  	err = r.client.Create(context.Background(), lv)</span>
<span class="diff-unchanged">  	if err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("Create LocalVolume fail %v", err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	defer r.DeleteFakeLocalVolume(t, lv)</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	// Get lv</span>
<span class="diff-unchanged">  	err = r.client.Get(context.Background(), types.NamespacedName{Namespace: lv.GetNamespace(), Name: lv.GetName()}, lv)</span>
<span class="diff-unchanged">  	if err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("Get lv fail %v", err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	fmt.Printf("lv = %+v", lv)</span>
<span class="diff-unchanged">  	fmt.Printf("r.storageMember = %+v", r.storageMember)</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	// Mock LocalVolume request</span>
<span class="diff-unchanged">  	req := reconcile.Request{NamespacedName: types.NamespacedName{Namespace: lv.GetNamespace(), Name: lv.GetName()}}</span>
<span class="diff-unchanged">  	_, err = r.Reconcile(context.TODO(), req)</span>
<span class="diff-unchanged">  	if err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("Reconcile fail %v", err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  }</span>
<span class="diff-added">+ </span>
<span class="diff-added">+ func TestReconcileLocalVolumeProcessing(t *testing.T) {</span>
<span class="diff-added">+     cli, s := CreateFakeClient()</span>
<span class="diff-added">+     lv := GenFakeLocalVolumeObject()</span>
<span class="diff-added">+     err := cli.Create(context.Background(), lv)</span>
<span class="diff-added">+     if err != nil {</span>
<span class="diff-added">+         t.Fatalf("Failed to create LocalVolume: %v", err)</span>
<span class="diff-added">+     }</span>
<span class="diff-added">+ </span>
<span class="diff-added">+     r := ReconcileLocalVolume{</span>
<span class="diff-added">+         client: cli,</span>
<span class="diff-added">+         scheme: s,</span>
<span class="diff-added">+         storageMember: member.Member().ConfigureController(s).ConfigureBase(fakeNodename, fakeNamespace, apisv1alpha1.SystemConfig{}, 0, cli, nil, fakeRecorder).ConfigureNode(s),</span>
<span class="diff-added">+     }</span>
<span class="diff-added">+ </span>
<span class="diff-added">+     req := reconcile.Request{NamespacedName: types.NamespacedName{Namespace: lv.GetNamespace(), Name: lv.GetName()}}</span>
<span class="diff-added">+     result, err := r.Reconcile(context.TODO(), req)</span>
<span class="diff-added">+     if err != nil {</span>
<span class="diff-added">+         t.Errorf("Reconcile returned an error: %v", err)</span>
<span class="diff-added">+     }</span>
<span class="diff-added">+     if result.Requeue {</span>
<span class="diff-added">+         t.Errorf("Reconcile unexpectedly requeued the request")</span>
<span class="diff-added">+     }</span>
<span class="diff-added">+ }</span>
<span class="diff-added">+ </span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  func TestReconcileLocalVolumeNotFound(t *testing.T) {</span>
<span class="diff-unchanged">      cli, s := CreateFakeClient()</span>
<span class="diff-unchanged">      r := ReconcileLocalVolume{</span>
<span class="diff-unchanged">          client: cli,</span>
<span class="diff-unchanged">          scheme: s,</span>
<span class="diff-unchanged">          storageMember: member.Member().ConfigureController(s).ConfigureBase(fakeNodename, fakeNamespace, apisv1alpha1.SystemConfig{}, 0, cli, nil, fakeRecorder).ConfigureNode(s),</span>
<span class="diff-unchanged">      }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">      req := reconcile.Request{NamespacedName: types.NamespacedName{Namespace: fakeNamespace, Name: "non-existent-volume"}}</span>
<span class="diff-unchanged">      result, err := r.Reconcile(context.TODO(), req)</span>
<span class="diff-unchanged">      if err != nil {</span>
<span class="diff-unchanged">          t.Errorf("Reconcile returned an error: %v", err)</span>
<span class="diff-unchanged">      }</span>
<span class="diff-unchanged">      if result.Requeue {</span>
<span class="diff-unchanged">          t.Errorf("Reconcile unexpectedly requeued the request")</span>
<span class="diff-unchanged">      }</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  // DeleteFakeLocalVolume</span>
<span class="diff-unchanged">  func (r *ReconcileLocalVolume) DeleteFakeLocalVolume(t *testing.T, lv *apisv1alpha1.LocalVolume) {</span>
<span class="diff-unchanged">  	if err := r.client.Delete(context.Background(), lv); err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("Delete LocalVolume %v fail %v", lv.GetName(), err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  // GenFakeLocalVolumeObject Create lv request</span>
<span class="diff-unchanged">  func GenFakeLocalVolumeObject() *apisv1alpha1.LocalVolume {</span>
<span class="diff-unchanged">  	lv := &apisv1alpha1.LocalVolume{}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	TypeMeta := metav1.TypeMeta{</span>
<span class="diff-unchanged">  		Kind:       LocalVolumeKind,</span>
<span class="diff-unchanged">  		APIVersion: apiversion,</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	ObjectMata := metav1.ObjectMeta{</span>
<span class="diff-unchanged">  		Name:              fakeLocalVolumeName,</span>
<span class="diff-unchanged">  		Namespace:         fakeNamespace,</span>
<span class="diff-unchanged">  		ResourceVersion:   "",</span>
<span class="diff-unchanged">  		UID:               types.UID(fakeLocalVolumeUID),</span>
<span class="diff-unchanged">  		CreationTimestamp: metav1.Time{Time: time.Now()},</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	Spec := apisv1alpha1.LocalVolumeSpec{</span>
<span class="diff-unchanged">  		RequiredCapacityBytes: fakeDiskCapacityBytes,</span>
<span class="diff-unchanged">  		ReplicaNumber:         1,</span>
<span class="diff-unchanged">  		PoolName:              fakeVgType,</span>
<span class="diff-unchanged">  		Delete:                false,</span>
<span class="diff-unchanged">  		Convertible:           true,</span>
<span class="diff-unchanged">  		Accessibility: apisv1alpha1.AccessibilityTopology{</span>
<span class="diff-unchanged">  			Nodes:   fakeNodenames,</span>
<span class="diff-unchanged">  			Regions: []string{fakeRegion},</span>
<span class="diff-unchanged">  			Zones:   []string{fakeZone},</span>
<span class="diff-unchanged">  		},</span>
<span class="diff-unchanged">  		Config: &apisv1alpha1.VolumeConfig{</span>
<span class="diff-unchanged">  			Convertible:           true,</span>
<span class="diff-unchanged">  			Initialized:           true,</span>
<span class="diff-unchanged">  			ReadyToInitialize:     true,</span>
<span class="diff-unchanged">  			RequiredCapacityBytes: fakeDiskCapacityBytes,</span>
<span class="diff-unchanged">  			ResourceID:            5,</span>
<span class="diff-unchanged">  			Version:               11,</span>
<span class="diff-unchanged">  			VolumeName:            fakeLocalVolumeName,</span>
<span class="diff-unchanged">  			Replicas: []apisv1alpha1.VolumeReplica{</span>
<span class="diff-unchanged">  				{</span>
<span class="diff-unchanged">  					Hostname: fakeNodename,</span>
<span class="diff-unchanged">  					ID:       1,</span>
<span class="diff-unchanged">  					IP:       fakeStorageIp,</span>
<span class="diff-unchanged">  					Primary:  true,</span>
<span class="diff-unchanged">  				},</span>
<span class="diff-unchanged">  			},</span>
<span class="diff-unchanged">  		},</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	lv.ObjectMeta = ObjectMata</span>
<span class="diff-unchanged">  	lv.TypeMeta = TypeMeta</span>
<span class="diff-unchanged">  	lv.Spec = Spec</span>
<span class="diff-unchanged">  	lv.Status.State = apisv1alpha1.VolumeStateCreating</span>
<span class="diff-unchanged">  	lv.Status.AllocatedCapacityBytes = fakeTotalCapacityBytes - fakeFreeCapacityBytes</span>
<span class="diff-unchanged">  	lv.Status.PublishedNodeName = fakeNodename</span>
<span class="diff-unchanged">  	lv.Status.Replicas = []string{fakeLocalVolumeName}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	return lv</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  // CreateFakeClient Create LocalVolume resource</span>
<span class="diff-unchanged">  func CreateFakeClient() (client.Client, *runtime.Scheme) {</span>
<span class="diff-unchanged">  	lv := GenFakeLocalVolumeObject()</span>
<span class="diff-unchanged">  	lvList := &apisv1alpha1.LocalVolumeList{</span>
<span class="diff-unchanged">  		TypeMeta: metav1.TypeMeta{</span>
<span class="diff-unchanged">  			Kind:       LocalVolumeKind,</span>
<span class="diff-unchanged">  			APIVersion: apiversion,</span>
<span class="diff-unchanged">  		},</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	s := scheme.Scheme</span>
<span class="diff-unchanged">  	s.AddKnownTypes(apisv1alpha1.SchemeGroupVersion, lv)</span>
<span class="diff-unchanged">  	s.AddKnownTypes(apisv1alpha1.SchemeGroupVersion, lvList)</span>
<span class="diff-unchanged">  	return fake.NewClientBuilder().WithScheme(s).Build(), s</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  func validateSystemConfig() error {</span>
<span class="diff-unchanged">  	var errMsgs []string</span>
<span class="diff-unchanged">  	switch apisv1alpha1.SystemMode(SystemModeDRBD) {</span>
<span class="diff-unchanged">  	case apisv1alpha1.SystemModeDRBD:</span>
<span class="diff-unchanged">  	default:</span>
<span class="diff-unchanged">  		errMsgs = append(errMsgs, fmt.Sprintf("system mode %s not supported", SystemModeDRBD))</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	if len(errMsgs) != 0 {</span>
<span class="diff-unchanged">  		return fmt.Errorf(strings.Join(errMsgs, "; "))</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	return nil</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  func getSystemConfig() (apisv1alpha1.SystemConfig, error) {</span>
<span class="diff-unchanged">  	if err := validateSystemConfig(); err != nil {</span>
<span class="diff-unchanged">  		return apisv1alpha1.SystemConfig{}, err</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	config := apisv1alpha1.SystemConfig{</span>
<span class="diff-unchanged">  		Mode:             apisv1alpha1.SystemMode(SystemModeDRBD),</span>
<span class="diff-unchanged">  		MaxHAVolumeCount: defaultHAVolumeTotalCount,</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	switch config.Mode {</span>
<span class="diff-unchanged">  	case apisv1alpha1.SystemModeDRBD:</span>
<span class="diff-unchanged">  		{</span>
<span class="diff-unchanged">  			config.DRBD = &apisv1alpha1.DRBDSystemConfig{</span>
<span class="diff-unchanged">  				StartPort: defaultDRBDStartPort,</span>
<span class="diff-unchanged">  			}</span>
<span class="diff-unchanged">  		}</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	return config, nil</span>
<span class="diff-unchanged">  }</span></code></pre>
                    </details>
                </td>
                <td>
                    <details>
                        <summary>View More</summary>
                        <div><strong>STDERR:</strong> <pre><code class="language-go"></code></pre></div>
                        <div><strong>STDOUT:</strong> <pre><code class="language-go">ok  	github.com/hwameistor/hwameistor/pkg/local-storage/controller/localvolume	0.060s	coverage: 30.8% of statements
</code></pre></div>
                        <div><strong>Test Code:</strong> <pre><code class="language-go">func TestReconcileLocalVolumeProcessing(t *testing.T) {
    cli, s := CreateFakeClient()
    lv := GenFakeLocalVolumeObject()
    err := cli.Create(context.Background(), lv)
    if err != nil {
        t.Fatalf("Failed to create LocalVolume: %v", err)
    }

    r := ReconcileLocalVolume{
        client: cli,
        scheme: s,
        storageMember: member.Member().ConfigureController(s).ConfigureBase(fakeNodename, fakeNamespace, apisv1alpha1.SystemConfig{}, 0, cli, nil, fakeRecorder).ConfigureNode(s),
    }

    req := reconcile.Request{NamespacedName: types.NamespacedName{Namespace: lv.GetNamespace(), Name: lv.GetName()}}
    result, err := r.Reconcile(context.TODO(), req)
    if err != nil {
        t.Errorf("Reconcile returned an error: %v", err)
    }
    if result.Requeue {
        t.Errorf("Reconcile unexpectedly requeued the request")
    }
}
</code></pre></div>
                        <div><strong>Imports:</strong> <pre><code class="language-go">""
</code></pre></div>
                    </details>
                </td>
            </tr>
            
            <tr>
                <td class="status-FAIL">FAIL</td>
                <td>Test failed</td>
                <td>1</td>
                <td>go</td>
                <td>
                    <details>
                        <summary>View Full Code</summary>
                        <pre><code><span class="diff-unchanged">  package localvolume</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  import (</span>
<span class="diff-unchanged">  	"context"</span>
<span class="diff-unchanged">  	"fmt"</span>
<span class="diff-unchanged">  	"strings"</span>
<span class="diff-unchanged">  	"testing"</span>
<span class="diff-unchanged">  	"time"</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"</span>
<span class="diff-unchanged">  	"k8s.io/apimachinery/pkg/runtime"</span>
<span class="diff-unchanged">  	"k8s.io/apimachinery/pkg/types"</span>
<span class="diff-unchanged">  	"k8s.io/client-go/kubernetes/scheme"</span>
<span class="diff-unchanged">  	"k8s.io/client-go/tools/record"</span>
<span class="diff-unchanged">  	"sigs.k8s.io/controller-runtime/pkg/cache"</span>
<span class="diff-unchanged">  	"sigs.k8s.io/controller-runtime/pkg/client"</span>
<span class="diff-unchanged">  	"sigs.k8s.io/controller-runtime/pkg/client/fake"</span>
<span class="diff-unchanged">  	"sigs.k8s.io/controller-runtime/pkg/reconcile"</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	apisv1alpha1 "github.com/hwameistor/hwameistor/pkg/apis/hwameistor/v1alpha1"</span>
<span class="diff-unchanged">  	"github.com/hwameistor/hwameistor/pkg/local-storage/member"</span>
<span class="diff-unchanged">  )</span>
<span class="diff-added">+ sigs.k8s.io/controller-runtime/pkg/source</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  // SystemMode of HA module</span>
<span class="diff-unchanged">  type SystemMode string</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  var (</span>
<span class="diff-unchanged">  	fakeLocalVolumeName          = "local-volume-example"</span>
<span class="diff-unchanged">  	fakeLocalVolumeUID           = "local-volume-uid"</span>
<span class="diff-unchanged">  	fakeNamespace                = "local-volume-test"</span>
<span class="diff-unchanged">  	fakeNodenames                = []string{"10-6-118-10"}</span>
<span class="diff-unchanged">  	fakeNodename                 = "10-6-118-10"</span>
<span class="diff-unchanged">  	fakeStorageIp                = "10.6.118.11"</span>
<span class="diff-unchanged">  	fakeZone                     = "zone-test"</span>
<span class="diff-unchanged">  	fakeRegion                   = "region-test"</span>
<span class="diff-unchanged">  	fakeVgType                   = "LocalStorage_PoolHDD"</span>
<span class="diff-unchanged">  	fakeVgName                   = "vg-test"</span>
<span class="diff-unchanged">  	fakePoolClass                = "HDD"</span>
<span class="diff-unchanged">  	fakePoolType                 = "REGULAR"</span>
<span class="diff-unchanged">  	fakeTotalCapacityBytes int64 = 10 * 1024 * 1024 * 1024</span>
<span class="diff-unchanged">  	fakeFreeCapacityBytes  int64 = 8 * 1024 * 1024 * 1024</span>
<span class="diff-unchanged">  	fakeDiskCapacityBytes  int64 = 2 * 1024 * 1024 * 1024</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	apiversion      = "hwameistor.io/v1alpha1"</span>
<span class="diff-unchanged">  	LocalVolumeKind = "LocalVolume"</span>
<span class="diff-unchanged">  	fakeRecorder    = record.NewFakeRecorder(100)</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	defaultDRBDStartPort                 = 43001</span>
<span class="diff-unchanged">  	defaultHAVolumeTotalCount            = 1000</span>
<span class="diff-unchanged">  	SystemModeDRBD            SystemMode = "drbd"</span>
<span class="diff-unchanged">  )</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  func TestNewLocalVolumeController(t *testing.T) {</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	systemConfig, err := getSystemConfig()</span>
<span class="diff-unchanged">  	if err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("invalid system config: %s", err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	var ca cache.Cache</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	cli, s := CreateFakeClient()</span>
<span class="diff-unchanged">  	// Create a Reconcile for LocalVolume</span>
<span class="diff-unchanged">  	r := ReconcileLocalVolume{</span>
<span class="diff-unchanged">  		client:        cli,</span>
<span class="diff-unchanged">  		scheme:        s,</span>
<span class="diff-unchanged">  		storageMember: member.Member().ConfigureController(s).ConfigureBase(fakeNodename, fakeNamespace, systemConfig, 0, cli, ca, fakeRecorder).ConfigureNode(s),</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	// Create LocalVolume</span>
<span class="diff-unchanged">  	lv := GenFakeLocalVolumeObject()</span>
<span class="diff-unchanged">  	err = r.client.Create(context.Background(), lv)</span>
<span class="diff-unchanged">  	if err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("Create LocalVolume fail %v", err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	defer r.DeleteFakeLocalVolume(t, lv)</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	// Get lv</span>
<span class="diff-unchanged">  	err = r.client.Get(context.Background(), types.NamespacedName{Namespace: lv.GetNamespace(), Name: lv.GetName()}, lv)</span>
<span class="diff-unchanged">  	if err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("Get lv fail %v", err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	fmt.Printf("lv = %+v", lv)</span>
<span class="diff-unchanged">  	fmt.Printf("r.storageMember = %+v", r.storageMember)</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	// Mock LocalVolume request</span>
<span class="diff-unchanged">  	req := reconcile.Request{NamespacedName: types.NamespacedName{Namespace: lv.GetNamespace(), Name: lv.GetName()}}</span>
<span class="diff-unchanged">  	_, err = r.Reconcile(context.TODO(), req)</span>
<span class="diff-unchanged">  	if err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("Reconcile fail %v", err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  }</span>
<span class="diff-added">+ </span>
<span class="diff-added">+ func TestAddFunctionWatchLocalVolumeReplicaFailure(t *testing.T) {</span>
<span class="diff-added">+     cli, s := CreateFakeClient()</span>
<span class="diff-added">+     mgr := &fakeManager{client: cli, scheme: s}</span>
<span class="diff-added">+ </span>
<span class="diff-added">+     // Mock the Watch function to simulate a failure for LocalVolumeReplica</span>
<span class="diff-added">+     originalWatch := (&source.Kind{}).Watch</span>
<span class="diff-added">+     defer func() { (&source.Kind{}).Watch = originalWatch }()</span>
<span class="diff-added">+     (&source.Kind{}).Watch = func(src source.Source, evthandler handler.EventHandler, predicates ...predicate.Predicate) error {</span>
<span class="diff-added">+         return fmt.Errorf("mock watch failure for LocalVolumeReplica")</span>
<span class="diff-added">+     }</span>
<span class="diff-added">+ </span>
<span class="diff-added">+     err := Add(mgr)</span>
<span class="diff-added">+     if err == nil {</span>
<span class="diff-added">+         t.Errorf("Expected error when Watch for LocalVolumeReplica fails, but got nil")</span>
<span class="diff-added">+     }</span>
<span class="diff-added">+ }</span>
<span class="diff-added">+ </span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  func TestReconcileLocalVolumeNotFound(t *testing.T) {</span>
<span class="diff-unchanged">      cli, s := CreateFakeClient()</span>
<span class="diff-unchanged">      r := ReconcileLocalVolume{</span>
<span class="diff-unchanged">          client: cli,</span>
<span class="diff-unchanged">          scheme: s,</span>
<span class="diff-unchanged">          storageMember: member.Member().ConfigureController(s).ConfigureBase(fakeNodename, fakeNamespace, apisv1alpha1.SystemConfig{}, 0, cli, nil, fakeRecorder).ConfigureNode(s),</span>
<span class="diff-unchanged">      }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">      req := reconcile.Request{NamespacedName: types.NamespacedName{Namespace: fakeNamespace, Name: "non-existent-volume"}}</span>
<span class="diff-unchanged">      result, err := r.Reconcile(context.TODO(), req)</span>
<span class="diff-unchanged">      if err != nil {</span>
<span class="diff-unchanged">          t.Errorf("Reconcile returned an error: %v", err)</span>
<span class="diff-unchanged">      }</span>
<span class="diff-unchanged">      if result.Requeue {</span>
<span class="diff-unchanged">          t.Errorf("Reconcile unexpectedly requeued the request")</span>
<span class="diff-unchanged">      }</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  // DeleteFakeLocalVolume</span>
<span class="diff-unchanged">  func (r *ReconcileLocalVolume) DeleteFakeLocalVolume(t *testing.T, lv *apisv1alpha1.LocalVolume) {</span>
<span class="diff-unchanged">  	if err := r.client.Delete(context.Background(), lv); err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("Delete LocalVolume %v fail %v", lv.GetName(), err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  // GenFakeLocalVolumeObject Create lv request</span>
<span class="diff-unchanged">  func GenFakeLocalVolumeObject() *apisv1alpha1.LocalVolume {</span>
<span class="diff-unchanged">  	lv := &apisv1alpha1.LocalVolume{}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	TypeMeta := metav1.TypeMeta{</span>
<span class="diff-unchanged">  		Kind:       LocalVolumeKind,</span>
<span class="diff-unchanged">  		APIVersion: apiversion,</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	ObjectMata := metav1.ObjectMeta{</span>
<span class="diff-unchanged">  		Name:              fakeLocalVolumeName,</span>
<span class="diff-unchanged">  		Namespace:         fakeNamespace,</span>
<span class="diff-unchanged">  		ResourceVersion:   "",</span>
<span class="diff-unchanged">  		UID:               types.UID(fakeLocalVolumeUID),</span>
<span class="diff-unchanged">  		CreationTimestamp: metav1.Time{Time: time.Now()},</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	Spec := apisv1alpha1.LocalVolumeSpec{</span>
<span class="diff-unchanged">  		RequiredCapacityBytes: fakeDiskCapacityBytes,</span>
<span class="diff-unchanged">  		ReplicaNumber:         1,</span>
<span class="diff-unchanged">  		PoolName:              fakeVgType,</span>
<span class="diff-unchanged">  		Delete:                false,</span>
<span class="diff-unchanged">  		Convertible:           true,</span>
<span class="diff-unchanged">  		Accessibility: apisv1alpha1.AccessibilityTopology{</span>
<span class="diff-unchanged">  			Nodes:   fakeNodenames,</span>
<span class="diff-unchanged">  			Regions: []string{fakeRegion},</span>
<span class="diff-unchanged">  			Zones:   []string{fakeZone},</span>
<span class="diff-unchanged">  		},</span>
<span class="diff-unchanged">  		Config: &apisv1alpha1.VolumeConfig{</span>
<span class="diff-unchanged">  			Convertible:           true,</span>
<span class="diff-unchanged">  			Initialized:           true,</span>
<span class="diff-unchanged">  			ReadyToInitialize:     true,</span>
<span class="diff-unchanged">  			RequiredCapacityBytes: fakeDiskCapacityBytes,</span>
<span class="diff-unchanged">  			ResourceID:            5,</span>
<span class="diff-unchanged">  			Version:               11,</span>
<span class="diff-unchanged">  			VolumeName:            fakeLocalVolumeName,</span>
<span class="diff-unchanged">  			Replicas: []apisv1alpha1.VolumeReplica{</span>
<span class="diff-unchanged">  				{</span>
<span class="diff-unchanged">  					Hostname: fakeNodename,</span>
<span class="diff-unchanged">  					ID:       1,</span>
<span class="diff-unchanged">  					IP:       fakeStorageIp,</span>
<span class="diff-unchanged">  					Primary:  true,</span>
<span class="diff-unchanged">  				},</span>
<span class="diff-unchanged">  			},</span>
<span class="diff-unchanged">  		},</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	lv.ObjectMeta = ObjectMata</span>
<span class="diff-unchanged">  	lv.TypeMeta = TypeMeta</span>
<span class="diff-unchanged">  	lv.Spec = Spec</span>
<span class="diff-unchanged">  	lv.Status.State = apisv1alpha1.VolumeStateCreating</span>
<span class="diff-unchanged">  	lv.Status.AllocatedCapacityBytes = fakeTotalCapacityBytes - fakeFreeCapacityBytes</span>
<span class="diff-unchanged">  	lv.Status.PublishedNodeName = fakeNodename</span>
<span class="diff-unchanged">  	lv.Status.Replicas = []string{fakeLocalVolumeName}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	return lv</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  // CreateFakeClient Create LocalVolume resource</span>
<span class="diff-unchanged">  func CreateFakeClient() (client.Client, *runtime.Scheme) {</span>
<span class="diff-unchanged">  	lv := GenFakeLocalVolumeObject()</span>
<span class="diff-unchanged">  	lvList := &apisv1alpha1.LocalVolumeList{</span>
<span class="diff-unchanged">  		TypeMeta: metav1.TypeMeta{</span>
<span class="diff-unchanged">  			Kind:       LocalVolumeKind,</span>
<span class="diff-unchanged">  			APIVersion: apiversion,</span>
<span class="diff-unchanged">  		},</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	s := scheme.Scheme</span>
<span class="diff-unchanged">  	s.AddKnownTypes(apisv1alpha1.SchemeGroupVersion, lv)</span>
<span class="diff-unchanged">  	s.AddKnownTypes(apisv1alpha1.SchemeGroupVersion, lvList)</span>
<span class="diff-unchanged">  	return fake.NewClientBuilder().WithScheme(s).Build(), s</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  func validateSystemConfig() error {</span>
<span class="diff-unchanged">  	var errMsgs []string</span>
<span class="diff-unchanged">  	switch apisv1alpha1.SystemMode(SystemModeDRBD) {</span>
<span class="diff-unchanged">  	case apisv1alpha1.SystemModeDRBD:</span>
<span class="diff-unchanged">  	default:</span>
<span class="diff-unchanged">  		errMsgs = append(errMsgs, fmt.Sprintf("system mode %s not supported", SystemModeDRBD))</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	if len(errMsgs) != 0 {</span>
<span class="diff-unchanged">  		return fmt.Errorf(strings.Join(errMsgs, "; "))</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	return nil</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  func getSystemConfig() (apisv1alpha1.SystemConfig, error) {</span>
<span class="diff-unchanged">  	if err := validateSystemConfig(); err != nil {</span>
<span class="diff-unchanged">  		return apisv1alpha1.SystemConfig{}, err</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	config := apisv1alpha1.SystemConfig{</span>
<span class="diff-unchanged">  		Mode:             apisv1alpha1.SystemMode(SystemModeDRBD),</span>
<span class="diff-unchanged">  		MaxHAVolumeCount: defaultHAVolumeTotalCount,</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	switch config.Mode {</span>
<span class="diff-unchanged">  	case apisv1alpha1.SystemModeDRBD:</span>
<span class="diff-unchanged">  		{</span>
<span class="diff-unchanged">  			config.DRBD = &apisv1alpha1.DRBDSystemConfig{</span>
<span class="diff-unchanged">  				StartPort: defaultDRBDStartPort,</span>
<span class="diff-unchanged">  			}</span>
<span class="diff-unchanged">  		}</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	return config, nil</span>
<span class="diff-unchanged">  }</span></code></pre>
                    </details>
                </td>
                <td>
                    <details>
                        <summary>View More</summary>
                        <div><strong>STDERR:</strong> <pre><code class="language-go"># github.com/hwameistor/hwameistor/pkg/local-storage/controller/localvolume
pkg/local-storage/controller/localvolume/localvolume_controller_test.go:23:1: expected declaration, found sigs
</code></pre></div>
                        <div><strong>STDOUT:</strong> <pre><code class="language-go">FAIL	github.com/hwameistor/hwameistor/pkg/local-storage/controller/localvolume [setup failed]
FAIL
</code></pre></div>
                        <div><strong>Test Code:</strong> <pre><code class="language-go">func TestAddFunctionWatchLocalVolumeReplicaFailure(t *testing.T) {
    cli, s := CreateFakeClient()
    mgr := &fakeManager{client: cli, scheme: s}

    // Mock the Watch function to simulate a failure for LocalVolumeReplica
    originalWatch := (&source.Kind{}).Watch
    defer func() { (&source.Kind{}).Watch = originalWatch }()
    (&source.Kind{}).Watch = func(src source.Source, evthandler handler.EventHandler, predicates ...predicate.Predicate) error {
        return fmt.Errorf("mock watch failure for LocalVolumeReplica")
    }

    err := Add(mgr)
    if err == nil {
        t.Errorf("Expected error when Watch for LocalVolumeReplica fails, but got nil")
    }
}
</code></pre></div>
                        <div><strong>Imports:</strong> <pre><code class="language-go">"sigs.k8s.io/controller-runtime/pkg/source"
</code></pre></div>
                    </details>
                </td>
            </tr>
            
            <tr>
                <td class="status-FAIL">FAIL</td>
                <td>Test failed</td>
                <td>2</td>
                <td>go</td>
                <td>
                    <details>
                        <summary>View Full Code</summary>
                        <pre><code><span class="diff-unchanged">  package localvolume</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  import (</span>
<span class="diff-unchanged">  	"context"</span>
<span class="diff-unchanged">  	"fmt"</span>
<span class="diff-unchanged">  	"strings"</span>
<span class="diff-unchanged">  	"testing"</span>
<span class="diff-unchanged">  	"time"</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"</span>
<span class="diff-unchanged">  	"k8s.io/apimachinery/pkg/runtime"</span>
<span class="diff-unchanged">  	"k8s.io/apimachinery/pkg/types"</span>
<span class="diff-unchanged">  	"k8s.io/client-go/kubernetes/scheme"</span>
<span class="diff-unchanged">  	"k8s.io/client-go/tools/record"</span>
<span class="diff-unchanged">  	"sigs.k8s.io/controller-runtime/pkg/cache"</span>
<span class="diff-unchanged">  	"sigs.k8s.io/controller-runtime/pkg/client"</span>
<span class="diff-unchanged">  	"sigs.k8s.io/controller-runtime/pkg/client/fake"</span>
<span class="diff-unchanged">  	"sigs.k8s.io/controller-runtime/pkg/reconcile"</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	apisv1alpha1 "github.com/hwameistor/hwameistor/pkg/apis/hwameistor/v1alpha1"</span>
<span class="diff-unchanged">  	"github.com/hwameistor/hwameistor/pkg/local-storage/member"</span>
<span class="diff-unchanged">  )</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  // SystemMode of HA module</span>
<span class="diff-unchanged">  type SystemMode string</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  var (</span>
<span class="diff-unchanged">  	fakeLocalVolumeName          = "local-volume-example"</span>
<span class="diff-unchanged">  	fakeLocalVolumeUID           = "local-volume-uid"</span>
<span class="diff-unchanged">  	fakeNamespace                = "local-volume-test"</span>
<span class="diff-unchanged">  	fakeNodenames                = []string{"10-6-118-10"}</span>
<span class="diff-unchanged">  	fakeNodename                 = "10-6-118-10"</span>
<span class="diff-unchanged">  	fakeStorageIp                = "10.6.118.11"</span>
<span class="diff-unchanged">  	fakeZone                     = "zone-test"</span>
<span class="diff-unchanged">  	fakeRegion                   = "region-test"</span>
<span class="diff-unchanged">  	fakeVgType                   = "LocalStorage_PoolHDD"</span>
<span class="diff-unchanged">  	fakeVgName                   = "vg-test"</span>
<span class="diff-unchanged">  	fakePoolClass                = "HDD"</span>
<span class="diff-unchanged">  	fakePoolType                 = "REGULAR"</span>
<span class="diff-unchanged">  	fakeTotalCapacityBytes int64 = 10 * 1024 * 1024 * 1024</span>
<span class="diff-unchanged">  	fakeFreeCapacityBytes  int64 = 8 * 1024 * 1024 * 1024</span>
<span class="diff-unchanged">  	fakeDiskCapacityBytes  int64 = 2 * 1024 * 1024 * 1024</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	apiversion      = "hwameistor.io/v1alpha1"</span>
<span class="diff-unchanged">  	LocalVolumeKind = "LocalVolume"</span>
<span class="diff-unchanged">  	fakeRecorder    = record.NewFakeRecorder(100)</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	defaultDRBDStartPort                 = 43001</span>
<span class="diff-unchanged">  	defaultHAVolumeTotalCount            = 1000</span>
<span class="diff-unchanged">  	SystemModeDRBD            SystemMode = "drbd"</span>
<span class="diff-unchanged">  )</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  func TestNewLocalVolumeController(t *testing.T) {</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	systemConfig, err := getSystemConfig()</span>
<span class="diff-unchanged">  	if err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("invalid system config: %s", err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	var ca cache.Cache</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	cli, s := CreateFakeClient()</span>
<span class="diff-unchanged">  	// Create a Reconcile for LocalVolume</span>
<span class="diff-unchanged">  	r := ReconcileLocalVolume{</span>
<span class="diff-unchanged">  		client:        cli,</span>
<span class="diff-unchanged">  		scheme:        s,</span>
<span class="diff-unchanged">  		storageMember: member.Member().ConfigureController(s).ConfigureBase(fakeNodename, fakeNamespace, systemConfig, 0, cli, ca, fakeRecorder).ConfigureNode(s),</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	// Create LocalVolume</span>
<span class="diff-unchanged">  	lv := GenFakeLocalVolumeObject()</span>
<span class="diff-unchanged">  	err = r.client.Create(context.Background(), lv)</span>
<span class="diff-unchanged">  	if err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("Create LocalVolume fail %v", err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	defer r.DeleteFakeLocalVolume(t, lv)</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	// Get lv</span>
<span class="diff-unchanged">  	err = r.client.Get(context.Background(), types.NamespacedName{Namespace: lv.GetNamespace(), Name: lv.GetName()}, lv)</span>
<span class="diff-unchanged">  	if err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("Get lv fail %v", err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	fmt.Printf("lv = %+v", lv)</span>
<span class="diff-unchanged">  	fmt.Printf("r.storageMember = %+v", r.storageMember)</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	// Mock LocalVolume request</span>
<span class="diff-unchanged">  	req := reconcile.Request{NamespacedName: types.NamespacedName{Namespace: lv.GetNamespace(), Name: lv.GetName()}}</span>
<span class="diff-unchanged">  	_, err = r.Reconcile(context.TODO(), req)</span>
<span class="diff-unchanged">  	if err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("Reconcile fail %v", err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  }</span>
<span class="diff-added">+ </span>
<span class="diff-added">+ func TestAddFunctionWithInvalidObjectHandling(t *testing.T) {</span>
<span class="diff-added">+     invalidObject := &apisv1alpha1.LocalVolume{}</span>
<span class="diff-added">+     replicaToVolumeRequestFunc := handler.EnqueueRequestsFromMapFunc(</span>
<span class="diff-added">+         func(a client.Object) []reconcile.Request {</span>
<span class="diff-added">+             replica, ok := a.(*apisv1alpha1.LocalVolumeReplica)</span>
<span class="diff-added">+             if !ok {</span>
<span class="diff-added">+                 return []reconcile.Request{}</span>
<span class="diff-added">+             }</span>
<span class="diff-added">+             return []reconcile.Request{</span>
<span class="diff-added">+                 {</span>
<span class="diff-added">+                     NamespacedName: types.NamespacedName{Name: replica.Spec.VolumeName},</span>
<span class="diff-added">+                 },</span>
<span class="diff-added">+             }</span>
<span class="diff-added">+         })</span>
<span class="diff-added">+ </span>
<span class="diff-added">+     requests := replicaToVolumeRequestFunc(invalidObject)</span>
<span class="diff-added">+     if len(requests) != 0 {</span>
<span class="diff-added">+         t.Errorf("Expected no requests for invalid object, but got %v", requests)</span>
<span class="diff-added">+     }</span>
<span class="diff-added">+ }</span>
<span class="diff-added">+ </span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  func TestReconcileLocalVolumeNotFound(t *testing.T) {</span>
<span class="diff-unchanged">      cli, s := CreateFakeClient()</span>
<span class="diff-unchanged">      r := ReconcileLocalVolume{</span>
<span class="diff-unchanged">          client: cli,</span>
<span class="diff-unchanged">          scheme: s,</span>
<span class="diff-unchanged">          storageMember: member.Member().ConfigureController(s).ConfigureBase(fakeNodename, fakeNamespace, apisv1alpha1.SystemConfig{}, 0, cli, nil, fakeRecorder).ConfigureNode(s),</span>
<span class="diff-unchanged">      }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">      req := reconcile.Request{NamespacedName: types.NamespacedName{Namespace: fakeNamespace, Name: "non-existent-volume"}}</span>
<span class="diff-unchanged">      result, err := r.Reconcile(context.TODO(), req)</span>
<span class="diff-unchanged">      if err != nil {</span>
<span class="diff-unchanged">          t.Errorf("Reconcile returned an error: %v", err)</span>
<span class="diff-unchanged">      }</span>
<span class="diff-unchanged">      if result.Requeue {</span>
<span class="diff-unchanged">          t.Errorf("Reconcile unexpectedly requeued the request")</span>
<span class="diff-unchanged">      }</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  // DeleteFakeLocalVolume</span>
<span class="diff-unchanged">  func (r *ReconcileLocalVolume) DeleteFakeLocalVolume(t *testing.T, lv *apisv1alpha1.LocalVolume) {</span>
<span class="diff-unchanged">  	if err := r.client.Delete(context.Background(), lv); err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("Delete LocalVolume %v fail %v", lv.GetName(), err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  // GenFakeLocalVolumeObject Create lv request</span>
<span class="diff-unchanged">  func GenFakeLocalVolumeObject() *apisv1alpha1.LocalVolume {</span>
<span class="diff-unchanged">  	lv := &apisv1alpha1.LocalVolume{}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	TypeMeta := metav1.TypeMeta{</span>
<span class="diff-unchanged">  		Kind:       LocalVolumeKind,</span>
<span class="diff-unchanged">  		APIVersion: apiversion,</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	ObjectMata := metav1.ObjectMeta{</span>
<span class="diff-unchanged">  		Name:              fakeLocalVolumeName,</span>
<span class="diff-unchanged">  		Namespace:         fakeNamespace,</span>
<span class="diff-unchanged">  		ResourceVersion:   "",</span>
<span class="diff-unchanged">  		UID:               types.UID(fakeLocalVolumeUID),</span>
<span class="diff-unchanged">  		CreationTimestamp: metav1.Time{Time: time.Now()},</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	Spec := apisv1alpha1.LocalVolumeSpec{</span>
<span class="diff-unchanged">  		RequiredCapacityBytes: fakeDiskCapacityBytes,</span>
<span class="diff-unchanged">  		ReplicaNumber:         1,</span>
<span class="diff-unchanged">  		PoolName:              fakeVgType,</span>
<span class="diff-unchanged">  		Delete:                false,</span>
<span class="diff-unchanged">  		Convertible:           true,</span>
<span class="diff-unchanged">  		Accessibility: apisv1alpha1.AccessibilityTopology{</span>
<span class="diff-unchanged">  			Nodes:   fakeNodenames,</span>
<span class="diff-unchanged">  			Regions: []string{fakeRegion},</span>
<span class="diff-unchanged">  			Zones:   []string{fakeZone},</span>
<span class="diff-unchanged">  		},</span>
<span class="diff-unchanged">  		Config: &apisv1alpha1.VolumeConfig{</span>
<span class="diff-unchanged">  			Convertible:           true,</span>
<span class="diff-unchanged">  			Initialized:           true,</span>
<span class="diff-unchanged">  			ReadyToInitialize:     true,</span>
<span class="diff-unchanged">  			RequiredCapacityBytes: fakeDiskCapacityBytes,</span>
<span class="diff-unchanged">  			ResourceID:            5,</span>
<span class="diff-unchanged">  			Version:               11,</span>
<span class="diff-unchanged">  			VolumeName:            fakeLocalVolumeName,</span>
<span class="diff-unchanged">  			Replicas: []apisv1alpha1.VolumeReplica{</span>
<span class="diff-unchanged">  				{</span>
<span class="diff-unchanged">  					Hostname: fakeNodename,</span>
<span class="diff-unchanged">  					ID:       1,</span>
<span class="diff-unchanged">  					IP:       fakeStorageIp,</span>
<span class="diff-unchanged">  					Primary:  true,</span>
<span class="diff-unchanged">  				},</span>
<span class="diff-unchanged">  			},</span>
<span class="diff-unchanged">  		},</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	lv.ObjectMeta = ObjectMata</span>
<span class="diff-unchanged">  	lv.TypeMeta = TypeMeta</span>
<span class="diff-unchanged">  	lv.Spec = Spec</span>
<span class="diff-unchanged">  	lv.Status.State = apisv1alpha1.VolumeStateCreating</span>
<span class="diff-unchanged">  	lv.Status.AllocatedCapacityBytes = fakeTotalCapacityBytes - fakeFreeCapacityBytes</span>
<span class="diff-unchanged">  	lv.Status.PublishedNodeName = fakeNodename</span>
<span class="diff-unchanged">  	lv.Status.Replicas = []string{fakeLocalVolumeName}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	return lv</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  // CreateFakeClient Create LocalVolume resource</span>
<span class="diff-unchanged">  func CreateFakeClient() (client.Client, *runtime.Scheme) {</span>
<span class="diff-unchanged">  	lv := GenFakeLocalVolumeObject()</span>
<span class="diff-unchanged">  	lvList := &apisv1alpha1.LocalVolumeList{</span>
<span class="diff-unchanged">  		TypeMeta: metav1.TypeMeta{</span>
<span class="diff-unchanged">  			Kind:       LocalVolumeKind,</span>
<span class="diff-unchanged">  			APIVersion: apiversion,</span>
<span class="diff-unchanged">  		},</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	s := scheme.Scheme</span>
<span class="diff-unchanged">  	s.AddKnownTypes(apisv1alpha1.SchemeGroupVersion, lv)</span>
<span class="diff-unchanged">  	s.AddKnownTypes(apisv1alpha1.SchemeGroupVersion, lvList)</span>
<span class="diff-unchanged">  	return fake.NewClientBuilder().WithScheme(s).Build(), s</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  func validateSystemConfig() error {</span>
<span class="diff-unchanged">  	var errMsgs []string</span>
<span class="diff-unchanged">  	switch apisv1alpha1.SystemMode(SystemModeDRBD) {</span>
<span class="diff-unchanged">  	case apisv1alpha1.SystemModeDRBD:</span>
<span class="diff-unchanged">  	default:</span>
<span class="diff-unchanged">  		errMsgs = append(errMsgs, fmt.Sprintf("system mode %s not supported", SystemModeDRBD))</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	if len(errMsgs) != 0 {</span>
<span class="diff-unchanged">  		return fmt.Errorf(strings.Join(errMsgs, "; "))</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	return nil</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  func getSystemConfig() (apisv1alpha1.SystemConfig, error) {</span>
<span class="diff-unchanged">  	if err := validateSystemConfig(); err != nil {</span>
<span class="diff-unchanged">  		return apisv1alpha1.SystemConfig{}, err</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	config := apisv1alpha1.SystemConfig{</span>
<span class="diff-unchanged">  		Mode:             apisv1alpha1.SystemMode(SystemModeDRBD),</span>
<span class="diff-unchanged">  		MaxHAVolumeCount: defaultHAVolumeTotalCount,</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	switch config.Mode {</span>
<span class="diff-unchanged">  	case apisv1alpha1.SystemModeDRBD:</span>
<span class="diff-unchanged">  		{</span>
<span class="diff-unchanged">  			config.DRBD = &apisv1alpha1.DRBDSystemConfig{</span>
<span class="diff-unchanged">  				StartPort: defaultDRBDStartPort,</span>
<span class="diff-unchanged">  			}</span>
<span class="diff-unchanged">  		}</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	return config, nil</span>
<span class="diff-unchanged">  }</span></code></pre>
                    </details>
                </td>
                <td>
                    <details>
                        <summary>View More</summary>
                        <div><strong>STDERR:</strong> <pre><code class="language-go"># github.com/hwameistor/hwameistor/pkg/local-storage/controller/localvolume [github.com/hwameistor/hwameistor/pkg/local-storage/controller/localvolume.test]
pkg/local-storage/controller/localvolume/localvolume_controller_test.go:96:35: undefined: handler
note: module requires Go 1.21
</code></pre></div>
                        <div><strong>STDOUT:</strong> <pre><code class="language-go">FAIL	github.com/hwameistor/hwameistor/pkg/local-storage/controller/localvolume [build failed]
FAIL
</code></pre></div>
                        <div><strong>Test Code:</strong> <pre><code class="language-go">func TestAddFunctionWithInvalidObjectHandling(t *testing.T) {
    invalidObject := &apisv1alpha1.LocalVolume{}
    replicaToVolumeRequestFunc := handler.EnqueueRequestsFromMapFunc(
        func(a client.Object) []reconcile.Request {
            replica, ok := a.(*apisv1alpha1.LocalVolumeReplica)
            if !ok {
                return []reconcile.Request{}
            }
            return []reconcile.Request{
                {
                    NamespacedName: types.NamespacedName{Name: replica.Spec.VolumeName},
                },
            }
        })

    requests := replicaToVolumeRequestFunc(invalidObject)
    if len(requests) != 0 {
        t.Errorf("Expected no requests for invalid object, but got %v", requests)
    }
}
</code></pre></div>
                        <div><strong>Imports:</strong> <pre><code class="language-go">""
</code></pre></div>
                    </details>
                </td>
            </tr>
            
            <tr>
                <td class="status-FAIL">FAIL</td>
                <td>Coverage did not increase. Maybe the test did run but did not increase coverage, or maybe the test execution was skipped due to some problem</td>
                <td>0</td>
                <td>go</td>
                <td>
                    <details>
                        <summary>View Full Code</summary>
                        <pre><code><span class="diff-unchanged">  package localvolume</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  import (</span>
<span class="diff-unchanged">  	"context"</span>
<span class="diff-unchanged">  	"fmt"</span>
<span class="diff-unchanged">  	"strings"</span>
<span class="diff-unchanged">  	"testing"</span>
<span class="diff-unchanged">  	"time"</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"</span>
<span class="diff-unchanged">  	"k8s.io/apimachinery/pkg/runtime"</span>
<span class="diff-unchanged">  	"k8s.io/apimachinery/pkg/types"</span>
<span class="diff-unchanged">  	"k8s.io/client-go/kubernetes/scheme"</span>
<span class="diff-unchanged">  	"k8s.io/client-go/tools/record"</span>
<span class="diff-unchanged">  	"sigs.k8s.io/controller-runtime/pkg/cache"</span>
<span class="diff-unchanged">  	"sigs.k8s.io/controller-runtime/pkg/client"</span>
<span class="diff-unchanged">  	"sigs.k8s.io/controller-runtime/pkg/client/fake"</span>
<span class="diff-unchanged">  	"sigs.k8s.io/controller-runtime/pkg/reconcile"</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	apisv1alpha1 "github.com/hwameistor/hwameistor/pkg/apis/hwameistor/v1alpha1"</span>
<span class="diff-unchanged">  	"github.com/hwameistor/hwameistor/pkg/local-storage/member"</span>
<span class="diff-unchanged">  )</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  // SystemMode of HA module</span>
<span class="diff-unchanged">  type SystemMode string</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  var (</span>
<span class="diff-unchanged">  	fakeLocalVolumeName          = "local-volume-example"</span>
<span class="diff-unchanged">  	fakeLocalVolumeUID           = "local-volume-uid"</span>
<span class="diff-unchanged">  	fakeNamespace                = "local-volume-test"</span>
<span class="diff-unchanged">  	fakeNodenames                = []string{"10-6-118-10"}</span>
<span class="diff-unchanged">  	fakeNodename                 = "10-6-118-10"</span>
<span class="diff-unchanged">  	fakeStorageIp                = "10.6.118.11"</span>
<span class="diff-unchanged">  	fakeZone                     = "zone-test"</span>
<span class="diff-unchanged">  	fakeRegion                   = "region-test"</span>
<span class="diff-unchanged">  	fakeVgType                   = "LocalStorage_PoolHDD"</span>
<span class="diff-unchanged">  	fakeVgName                   = "vg-test"</span>
<span class="diff-unchanged">  	fakePoolClass                = "HDD"</span>
<span class="diff-unchanged">  	fakePoolType                 = "REGULAR"</span>
<span class="diff-unchanged">  	fakeTotalCapacityBytes int64 = 10 * 1024 * 1024 * 1024</span>
<span class="diff-unchanged">  	fakeFreeCapacityBytes  int64 = 8 * 1024 * 1024 * 1024</span>
<span class="diff-unchanged">  	fakeDiskCapacityBytes  int64 = 2 * 1024 * 1024 * 1024</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	apiversion      = "hwameistor.io/v1alpha1"</span>
<span class="diff-unchanged">  	LocalVolumeKind = "LocalVolume"</span>
<span class="diff-unchanged">  	fakeRecorder    = record.NewFakeRecorder(100)</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	defaultDRBDStartPort                 = 43001</span>
<span class="diff-unchanged">  	defaultHAVolumeTotalCount            = 1000</span>
<span class="diff-unchanged">  	SystemModeDRBD            SystemMode = "drbd"</span>
<span class="diff-unchanged">  )</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  func TestNewLocalVolumeController(t *testing.T) {</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	systemConfig, err := getSystemConfig()</span>
<span class="diff-unchanged">  	if err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("invalid system config: %s", err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	var ca cache.Cache</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	cli, s := CreateFakeClient()</span>
<span class="diff-unchanged">  	// Create a Reconcile for LocalVolume</span>
<span class="diff-unchanged">  	r := ReconcileLocalVolume{</span>
<span class="diff-unchanged">  		client:        cli,</span>
<span class="diff-unchanged">  		scheme:        s,</span>
<span class="diff-unchanged">  		storageMember: member.Member().ConfigureController(s).ConfigureBase(fakeNodename, fakeNamespace, systemConfig, 0, cli, ca, fakeRecorder).ConfigureNode(s),</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	// Create LocalVolume</span>
<span class="diff-unchanged">  	lv := GenFakeLocalVolumeObject()</span>
<span class="diff-unchanged">  	err = r.client.Create(context.Background(), lv)</span>
<span class="diff-unchanged">  	if err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("Create LocalVolume fail %v", err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	defer r.DeleteFakeLocalVolume(t, lv)</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	// Get lv</span>
<span class="diff-unchanged">  	err = r.client.Get(context.Background(), types.NamespacedName{Namespace: lv.GetNamespace(), Name: lv.GetName()}, lv)</span>
<span class="diff-unchanged">  	if err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("Get lv fail %v", err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	fmt.Printf("lv = %+v", lv)</span>
<span class="diff-unchanged">  	fmt.Printf("r.storageMember = %+v", r.storageMember)</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	// Mock LocalVolume request</span>
<span class="diff-unchanged">  	req := reconcile.Request{NamespacedName: types.NamespacedName{Namespace: lv.GetNamespace(), Name: lv.GetName()}}</span>
<span class="diff-unchanged">  	_, err = r.Reconcile(context.TODO(), req)</span>
<span class="diff-unchanged">  	if err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("Reconcile fail %v", err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  }</span>
<span class="diff-added">+ </span>
<span class="diff-added">+ func TestReconcileLocalVolumeObjectNotFound(t *testing.T) {</span>
<span class="diff-added">+     cli, s := CreateFakeClient()</span>
<span class="diff-added">+ </span>
<span class="diff-added">+     r := ReconcileLocalVolume{</span>
<span class="diff-added">+         client:        cli,</span>
<span class="diff-added">+         scheme:        s,</span>
<span class="diff-added">+         storageMember: member.Member(),</span>
<span class="diff-added">+     }</span>
<span class="diff-added">+ </span>
<span class="diff-added">+     req := reconcile.Request{NamespacedName: types.NamespacedName{Namespace: "nonexistent-namespace", Name: "nonexistent-name"}}</span>
<span class="diff-added">+     result, err := r.Reconcile(context.TODO(), req)</span>
<span class="diff-added">+     if err != nil {</span>
<span class="diff-added">+         t.Errorf("Reconcile returned an error: %v", err)</span>
<span class="diff-added">+     }</span>
<span class="diff-added">+     if result.Requeue {</span>
<span class="diff-added">+         t.Errorf("Reconcile unexpectedly requeued the request for a non-existent object")</span>
<span class="diff-added">+     }</span>
<span class="diff-added">+ }</span>
<span class="diff-added">+ </span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  func TestReconcileLocalVolumeNotFound(t *testing.T) {</span>
<span class="diff-unchanged">      cli, s := CreateFakeClient()</span>
<span class="diff-unchanged">      r := ReconcileLocalVolume{</span>
<span class="diff-unchanged">          client: cli,</span>
<span class="diff-unchanged">          scheme: s,</span>
<span class="diff-unchanged">          storageMember: member.Member().ConfigureController(s).ConfigureBase(fakeNodename, fakeNamespace, apisv1alpha1.SystemConfig{}, 0, cli, nil, fakeRecorder).ConfigureNode(s),</span>
<span class="diff-unchanged">      }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">      req := reconcile.Request{NamespacedName: types.NamespacedName{Namespace: fakeNamespace, Name: "non-existent-volume"}}</span>
<span class="diff-unchanged">      result, err := r.Reconcile(context.TODO(), req)</span>
<span class="diff-unchanged">      if err != nil {</span>
<span class="diff-unchanged">          t.Errorf("Reconcile returned an error: %v", err)</span>
<span class="diff-unchanged">      }</span>
<span class="diff-unchanged">      if result.Requeue {</span>
<span class="diff-unchanged">          t.Errorf("Reconcile unexpectedly requeued the request")</span>
<span class="diff-unchanged">      }</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  // DeleteFakeLocalVolume</span>
<span class="diff-unchanged">  func (r *ReconcileLocalVolume) DeleteFakeLocalVolume(t *testing.T, lv *apisv1alpha1.LocalVolume) {</span>
<span class="diff-unchanged">  	if err := r.client.Delete(context.Background(), lv); err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("Delete LocalVolume %v fail %v", lv.GetName(), err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  // GenFakeLocalVolumeObject Create lv request</span>
<span class="diff-unchanged">  func GenFakeLocalVolumeObject() *apisv1alpha1.LocalVolume {</span>
<span class="diff-unchanged">  	lv := &apisv1alpha1.LocalVolume{}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	TypeMeta := metav1.TypeMeta{</span>
<span class="diff-unchanged">  		Kind:       LocalVolumeKind,</span>
<span class="diff-unchanged">  		APIVersion: apiversion,</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	ObjectMata := metav1.ObjectMeta{</span>
<span class="diff-unchanged">  		Name:              fakeLocalVolumeName,</span>
<span class="diff-unchanged">  		Namespace:         fakeNamespace,</span>
<span class="diff-unchanged">  		ResourceVersion:   "",</span>
<span class="diff-unchanged">  		UID:               types.UID(fakeLocalVolumeUID),</span>
<span class="diff-unchanged">  		CreationTimestamp: metav1.Time{Time: time.Now()},</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	Spec := apisv1alpha1.LocalVolumeSpec{</span>
<span class="diff-unchanged">  		RequiredCapacityBytes: fakeDiskCapacityBytes,</span>
<span class="diff-unchanged">  		ReplicaNumber:         1,</span>
<span class="diff-unchanged">  		PoolName:              fakeVgType,</span>
<span class="diff-unchanged">  		Delete:                false,</span>
<span class="diff-unchanged">  		Convertible:           true,</span>
<span class="diff-unchanged">  		Accessibility: apisv1alpha1.AccessibilityTopology{</span>
<span class="diff-unchanged">  			Nodes:   fakeNodenames,</span>
<span class="diff-unchanged">  			Regions: []string{fakeRegion},</span>
<span class="diff-unchanged">  			Zones:   []string{fakeZone},</span>
<span class="diff-unchanged">  		},</span>
<span class="diff-unchanged">  		Config: &apisv1alpha1.VolumeConfig{</span>
<span class="diff-unchanged">  			Convertible:           true,</span>
<span class="diff-unchanged">  			Initialized:           true,</span>
<span class="diff-unchanged">  			ReadyToInitialize:     true,</span>
<span class="diff-unchanged">  			RequiredCapacityBytes: fakeDiskCapacityBytes,</span>
<span class="diff-unchanged">  			ResourceID:            5,</span>
<span class="diff-unchanged">  			Version:               11,</span>
<span class="diff-unchanged">  			VolumeName:            fakeLocalVolumeName,</span>
<span class="diff-unchanged">  			Replicas: []apisv1alpha1.VolumeReplica{</span>
<span class="diff-unchanged">  				{</span>
<span class="diff-unchanged">  					Hostname: fakeNodename,</span>
<span class="diff-unchanged">  					ID:       1,</span>
<span class="diff-unchanged">  					IP:       fakeStorageIp,</span>
<span class="diff-unchanged">  					Primary:  true,</span>
<span class="diff-unchanged">  				},</span>
<span class="diff-unchanged">  			},</span>
<span class="diff-unchanged">  		},</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	lv.ObjectMeta = ObjectMata</span>
<span class="diff-unchanged">  	lv.TypeMeta = TypeMeta</span>
<span class="diff-unchanged">  	lv.Spec = Spec</span>
<span class="diff-unchanged">  	lv.Status.State = apisv1alpha1.VolumeStateCreating</span>
<span class="diff-unchanged">  	lv.Status.AllocatedCapacityBytes = fakeTotalCapacityBytes - fakeFreeCapacityBytes</span>
<span class="diff-unchanged">  	lv.Status.PublishedNodeName = fakeNodename</span>
<span class="diff-unchanged">  	lv.Status.Replicas = []string{fakeLocalVolumeName}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	return lv</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  // CreateFakeClient Create LocalVolume resource</span>
<span class="diff-unchanged">  func CreateFakeClient() (client.Client, *runtime.Scheme) {</span>
<span class="diff-unchanged">  	lv := GenFakeLocalVolumeObject()</span>
<span class="diff-unchanged">  	lvList := &apisv1alpha1.LocalVolumeList{</span>
<span class="diff-unchanged">  		TypeMeta: metav1.TypeMeta{</span>
<span class="diff-unchanged">  			Kind:       LocalVolumeKind,</span>
<span class="diff-unchanged">  			APIVersion: apiversion,</span>
<span class="diff-unchanged">  		},</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	s := scheme.Scheme</span>
<span class="diff-unchanged">  	s.AddKnownTypes(apisv1alpha1.SchemeGroupVersion, lv)</span>
<span class="diff-unchanged">  	s.AddKnownTypes(apisv1alpha1.SchemeGroupVersion, lvList)</span>
<span class="diff-unchanged">  	return fake.NewClientBuilder().WithScheme(s).Build(), s</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  func validateSystemConfig() error {</span>
<span class="diff-unchanged">  	var errMsgs []string</span>
<span class="diff-unchanged">  	switch apisv1alpha1.SystemMode(SystemModeDRBD) {</span>
<span class="diff-unchanged">  	case apisv1alpha1.SystemModeDRBD:</span>
<span class="diff-unchanged">  	default:</span>
<span class="diff-unchanged">  		errMsgs = append(errMsgs, fmt.Sprintf("system mode %s not supported", SystemModeDRBD))</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	if len(errMsgs) != 0 {</span>
<span class="diff-unchanged">  		return fmt.Errorf(strings.Join(errMsgs, "; "))</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	return nil</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  func getSystemConfig() (apisv1alpha1.SystemConfig, error) {</span>
<span class="diff-unchanged">  	if err := validateSystemConfig(); err != nil {</span>
<span class="diff-unchanged">  		return apisv1alpha1.SystemConfig{}, err</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	config := apisv1alpha1.SystemConfig{</span>
<span class="diff-unchanged">  		Mode:             apisv1alpha1.SystemMode(SystemModeDRBD),</span>
<span class="diff-unchanged">  		MaxHAVolumeCount: defaultHAVolumeTotalCount,</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	switch config.Mode {</span>
<span class="diff-unchanged">  	case apisv1alpha1.SystemModeDRBD:</span>
<span class="diff-unchanged">  		{</span>
<span class="diff-unchanged">  			config.DRBD = &apisv1alpha1.DRBDSystemConfig{</span>
<span class="diff-unchanged">  				StartPort: defaultDRBDStartPort,</span>
<span class="diff-unchanged">  			}</span>
<span class="diff-unchanged">  		}</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	return config, nil</span>
<span class="diff-unchanged">  }</span></code></pre>
                    </details>
                </td>
                <td>
                    <details>
                        <summary>View More</summary>
                        <div><strong>STDERR:</strong> <pre><code class="language-go"></code></pre></div>
                        <div><strong>STDOUT:</strong> <pre><code class="language-go">ok  	github.com/hwameistor/hwameistor/pkg/local-storage/controller/localvolume	0.064s	coverage: 30.8% of statements
</code></pre></div>
                        <div><strong>Test Code:</strong> <pre><code class="language-go">func TestReconcileLocalVolumeObjectNotFound(t *testing.T) {
    cli, s := CreateFakeClient()

    r := ReconcileLocalVolume{
        client:        cli,
        scheme:        s,
        storageMember: member.Member(),
    }

    req := reconcile.Request{NamespacedName: types.NamespacedName{Namespace: "nonexistent-namespace", Name: "nonexistent-name"}}
    result, err := r.Reconcile(context.TODO(), req)
    if err != nil {
        t.Errorf("Reconcile returned an error: %v", err)
    }
    if result.Requeue {
        t.Errorf("Reconcile unexpectedly requeued the request for a non-existent object")
    }
}
</code></pre></div>
                        <div><strong>Imports:</strong> <pre><code class="language-go">""
</code></pre></div>
                    </details>
                </td>
            </tr>
            
            <tr>
                <td class="status-FAIL">FAIL</td>
                <td>Test failed</td>
                <td>1</td>
                <td>go</td>
                <td>
                    <details>
                        <summary>View Full Code</summary>
                        <pre><code><span class="diff-unchanged">  package localvolume</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  import (</span>
<span class="diff-unchanged">  	"context"</span>
<span class="diff-unchanged">  	"fmt"</span>
<span class="diff-unchanged">  	"strings"</span>
<span class="diff-unchanged">  	"testing"</span>
<span class="diff-unchanged">  	"time"</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"</span>
<span class="diff-unchanged">  	"k8s.io/apimachinery/pkg/runtime"</span>
<span class="diff-unchanged">  	"k8s.io/apimachinery/pkg/types"</span>
<span class="diff-unchanged">  	"k8s.io/client-go/kubernetes/scheme"</span>
<span class="diff-unchanged">  	"k8s.io/client-go/tools/record"</span>
<span class="diff-unchanged">  	"sigs.k8s.io/controller-runtime/pkg/cache"</span>
<span class="diff-unchanged">  	"sigs.k8s.io/controller-runtime/pkg/client"</span>
<span class="diff-unchanged">  	"sigs.k8s.io/controller-runtime/pkg/client/fake"</span>
<span class="diff-unchanged">  	"sigs.k8s.io/controller-runtime/pkg/reconcile"</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	apisv1alpha1 "github.com/hwameistor/hwameistor/pkg/apis/hwameistor/v1alpha1"</span>
<span class="diff-unchanged">  	"github.com/hwameistor/hwameistor/pkg/local-storage/member"</span>
<span class="diff-unchanged">  )</span>
<span class="diff-added">+ sigs.k8s.io/controller-runtime/pkg/controller</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  // SystemMode of HA module</span>
<span class="diff-unchanged">  type SystemMode string</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  var (</span>
<span class="diff-unchanged">  	fakeLocalVolumeName          = "local-volume-example"</span>
<span class="diff-unchanged">  	fakeLocalVolumeUID           = "local-volume-uid"</span>
<span class="diff-unchanged">  	fakeNamespace                = "local-volume-test"</span>
<span class="diff-unchanged">  	fakeNodenames                = []string{"10-6-118-10"}</span>
<span class="diff-unchanged">  	fakeNodename                 = "10-6-118-10"</span>
<span class="diff-unchanged">  	fakeStorageIp                = "10.6.118.11"</span>
<span class="diff-unchanged">  	fakeZone                     = "zone-test"</span>
<span class="diff-unchanged">  	fakeRegion                   = "region-test"</span>
<span class="diff-unchanged">  	fakeVgType                   = "LocalStorage_PoolHDD"</span>
<span class="diff-unchanged">  	fakeVgName                   = "vg-test"</span>
<span class="diff-unchanged">  	fakePoolClass                = "HDD"</span>
<span class="diff-unchanged">  	fakePoolType                 = "REGULAR"</span>
<span class="diff-unchanged">  	fakeTotalCapacityBytes int64 = 10 * 1024 * 1024 * 1024</span>
<span class="diff-unchanged">  	fakeFreeCapacityBytes  int64 = 8 * 1024 * 1024 * 1024</span>
<span class="diff-unchanged">  	fakeDiskCapacityBytes  int64 = 2 * 1024 * 1024 * 1024</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	apiversion      = "hwameistor.io/v1alpha1"</span>
<span class="diff-unchanged">  	LocalVolumeKind = "LocalVolume"</span>
<span class="diff-unchanged">  	fakeRecorder    = record.NewFakeRecorder(100)</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	defaultDRBDStartPort                 = 43001</span>
<span class="diff-unchanged">  	defaultHAVolumeTotalCount            = 1000</span>
<span class="diff-unchanged">  	SystemModeDRBD            SystemMode = "drbd"</span>
<span class="diff-unchanged">  )</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  func TestNewLocalVolumeController(t *testing.T) {</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	systemConfig, err := getSystemConfig()</span>
<span class="diff-unchanged">  	if err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("invalid system config: %s", err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	var ca cache.Cache</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	cli, s := CreateFakeClient()</span>
<span class="diff-unchanged">  	// Create a Reconcile for LocalVolume</span>
<span class="diff-unchanged">  	r := ReconcileLocalVolume{</span>
<span class="diff-unchanged">  		client:        cli,</span>
<span class="diff-unchanged">  		scheme:        s,</span>
<span class="diff-unchanged">  		storageMember: member.Member().ConfigureController(s).ConfigureBase(fakeNodename, fakeNamespace, systemConfig, 0, cli, ca, fakeRecorder).ConfigureNode(s),</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	// Create LocalVolume</span>
<span class="diff-unchanged">  	lv := GenFakeLocalVolumeObject()</span>
<span class="diff-unchanged">  	err = r.client.Create(context.Background(), lv)</span>
<span class="diff-unchanged">  	if err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("Create LocalVolume fail %v", err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	defer r.DeleteFakeLocalVolume(t, lv)</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	// Get lv</span>
<span class="diff-unchanged">  	err = r.client.Get(context.Background(), types.NamespacedName{Namespace: lv.GetNamespace(), Name: lv.GetName()}, lv)</span>
<span class="diff-unchanged">  	if err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("Get lv fail %v", err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	fmt.Printf("lv = %+v", lv)</span>
<span class="diff-unchanged">  	fmt.Printf("r.storageMember = %+v", r.storageMember)</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	// Mock LocalVolume request</span>
<span class="diff-unchanged">  	req := reconcile.Request{NamespacedName: types.NamespacedName{Namespace: lv.GetNamespace(), Name: lv.GetName()}}</span>
<span class="diff-unchanged">  	_, err = r.Reconcile(context.TODO(), req)</span>
<span class="diff-unchanged">  	if err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("Reconcile fail %v", err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  }</span>
<span class="diff-added">+ </span>
<span class="diff-added">+ func TestAddFunctionControllerCreationError(t *testing.T) {</span>
<span class="diff-added">+     cli, s := CreateFakeClient()</span>
<span class="diff-added">+     mgr := &fakeManager{client: cli, scheme: s}</span>
<span class="diff-added">+ </span>
<span class="diff-added">+     // Mock the controller.New function to simulate a failure</span>
<span class="diff-added">+     originalControllerNew := controller.New</span>
<span class="diff-added">+     defer func() { controller.New = originalControllerNew }()</span>
<span class="diff-added">+     controller.New = func(name string, mgr manager.Manager, options controller.Options) (controller.Controller, error) {</span>
<span class="diff-added">+         return nil, fmt.Errorf("mock controller creation failure")</span>
<span class="diff-added">+     }</span>
<span class="diff-added">+ </span>
<span class="diff-added">+     err := Add(mgr)</span>
<span class="diff-added">+     if err == nil {</span>
<span class="diff-added">+         t.Errorf("Expected error when controller creation fails, but got nil")</span>
<span class="diff-added">+     }</span>
<span class="diff-added">+ }</span>
<span class="diff-added">+ </span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  func TestReconcileLocalVolumeNotFound(t *testing.T) {</span>
<span class="diff-unchanged">      cli, s := CreateFakeClient()</span>
<span class="diff-unchanged">      r := ReconcileLocalVolume{</span>
<span class="diff-unchanged">          client: cli,</span>
<span class="diff-unchanged">          scheme: s,</span>
<span class="diff-unchanged">          storageMember: member.Member().ConfigureController(s).ConfigureBase(fakeNodename, fakeNamespace, apisv1alpha1.SystemConfig{}, 0, cli, nil, fakeRecorder).ConfigureNode(s),</span>
<span class="diff-unchanged">      }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">      req := reconcile.Request{NamespacedName: types.NamespacedName{Namespace: fakeNamespace, Name: "non-existent-volume"}}</span>
<span class="diff-unchanged">      result, err := r.Reconcile(context.TODO(), req)</span>
<span class="diff-unchanged">      if err != nil {</span>
<span class="diff-unchanged">          t.Errorf("Reconcile returned an error: %v", err)</span>
<span class="diff-unchanged">      }</span>
<span class="diff-unchanged">      if result.Requeue {</span>
<span class="diff-unchanged">          t.Errorf("Reconcile unexpectedly requeued the request")</span>
<span class="diff-unchanged">      }</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  // DeleteFakeLocalVolume</span>
<span class="diff-unchanged">  func (r *ReconcileLocalVolume) DeleteFakeLocalVolume(t *testing.T, lv *apisv1alpha1.LocalVolume) {</span>
<span class="diff-unchanged">  	if err := r.client.Delete(context.Background(), lv); err != nil {</span>
<span class="diff-unchanged">  		t.Errorf("Delete LocalVolume %v fail %v", lv.GetName(), err)</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  // GenFakeLocalVolumeObject Create lv request</span>
<span class="diff-unchanged">  func GenFakeLocalVolumeObject() *apisv1alpha1.LocalVolume {</span>
<span class="diff-unchanged">  	lv := &apisv1alpha1.LocalVolume{}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	TypeMeta := metav1.TypeMeta{</span>
<span class="diff-unchanged">  		Kind:       LocalVolumeKind,</span>
<span class="diff-unchanged">  		APIVersion: apiversion,</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	ObjectMata := metav1.ObjectMeta{</span>
<span class="diff-unchanged">  		Name:              fakeLocalVolumeName,</span>
<span class="diff-unchanged">  		Namespace:         fakeNamespace,</span>
<span class="diff-unchanged">  		ResourceVersion:   "",</span>
<span class="diff-unchanged">  		UID:               types.UID(fakeLocalVolumeUID),</span>
<span class="diff-unchanged">  		CreationTimestamp: metav1.Time{Time: time.Now()},</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	Spec := apisv1alpha1.LocalVolumeSpec{</span>
<span class="diff-unchanged">  		RequiredCapacityBytes: fakeDiskCapacityBytes,</span>
<span class="diff-unchanged">  		ReplicaNumber:         1,</span>
<span class="diff-unchanged">  		PoolName:              fakeVgType,</span>
<span class="diff-unchanged">  		Delete:                false,</span>
<span class="diff-unchanged">  		Convertible:           true,</span>
<span class="diff-unchanged">  		Accessibility: apisv1alpha1.AccessibilityTopology{</span>
<span class="diff-unchanged">  			Nodes:   fakeNodenames,</span>
<span class="diff-unchanged">  			Regions: []string{fakeRegion},</span>
<span class="diff-unchanged">  			Zones:   []string{fakeZone},</span>
<span class="diff-unchanged">  		},</span>
<span class="diff-unchanged">  		Config: &apisv1alpha1.VolumeConfig{</span>
<span class="diff-unchanged">  			Convertible:           true,</span>
<span class="diff-unchanged">  			Initialized:           true,</span>
<span class="diff-unchanged">  			ReadyToInitialize:     true,</span>
<span class="diff-unchanged">  			RequiredCapacityBytes: fakeDiskCapacityBytes,</span>
<span class="diff-unchanged">  			ResourceID:            5,</span>
<span class="diff-unchanged">  			Version:               11,</span>
<span class="diff-unchanged">  			VolumeName:            fakeLocalVolumeName,</span>
<span class="diff-unchanged">  			Replicas: []apisv1alpha1.VolumeReplica{</span>
<span class="diff-unchanged">  				{</span>
<span class="diff-unchanged">  					Hostname: fakeNodename,</span>
<span class="diff-unchanged">  					ID:       1,</span>
<span class="diff-unchanged">  					IP:       fakeStorageIp,</span>
<span class="diff-unchanged">  					Primary:  true,</span>
<span class="diff-unchanged">  				},</span>
<span class="diff-unchanged">  			},</span>
<span class="diff-unchanged">  		},</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	lv.ObjectMeta = ObjectMata</span>
<span class="diff-unchanged">  	lv.TypeMeta = TypeMeta</span>
<span class="diff-unchanged">  	lv.Spec = Spec</span>
<span class="diff-unchanged">  	lv.Status.State = apisv1alpha1.VolumeStateCreating</span>
<span class="diff-unchanged">  	lv.Status.AllocatedCapacityBytes = fakeTotalCapacityBytes - fakeFreeCapacityBytes</span>
<span class="diff-unchanged">  	lv.Status.PublishedNodeName = fakeNodename</span>
<span class="diff-unchanged">  	lv.Status.Replicas = []string{fakeLocalVolumeName}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	return lv</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  // CreateFakeClient Create LocalVolume resource</span>
<span class="diff-unchanged">  func CreateFakeClient() (client.Client, *runtime.Scheme) {</span>
<span class="diff-unchanged">  	lv := GenFakeLocalVolumeObject()</span>
<span class="diff-unchanged">  	lvList := &apisv1alpha1.LocalVolumeList{</span>
<span class="diff-unchanged">  		TypeMeta: metav1.TypeMeta{</span>
<span class="diff-unchanged">  			Kind:       LocalVolumeKind,</span>
<span class="diff-unchanged">  			APIVersion: apiversion,</span>
<span class="diff-unchanged">  		},</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	s := scheme.Scheme</span>
<span class="diff-unchanged">  	s.AddKnownTypes(apisv1alpha1.SchemeGroupVersion, lv)</span>
<span class="diff-unchanged">  	s.AddKnownTypes(apisv1alpha1.SchemeGroupVersion, lvList)</span>
<span class="diff-unchanged">  	return fake.NewClientBuilder().WithScheme(s).Build(), s</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  func validateSystemConfig() error {</span>
<span class="diff-unchanged">  	var errMsgs []string</span>
<span class="diff-unchanged">  	switch apisv1alpha1.SystemMode(SystemModeDRBD) {</span>
<span class="diff-unchanged">  	case apisv1alpha1.SystemModeDRBD:</span>
<span class="diff-unchanged">  	default:</span>
<span class="diff-unchanged">  		errMsgs = append(errMsgs, fmt.Sprintf("system mode %s not supported", SystemModeDRBD))</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	if len(errMsgs) != 0 {</span>
<span class="diff-unchanged">  		return fmt.Errorf(strings.Join(errMsgs, "; "))</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	return nil</span>
<span class="diff-unchanged">  }</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  func getSystemConfig() (apisv1alpha1.SystemConfig, error) {</span>
<span class="diff-unchanged">  	if err := validateSystemConfig(); err != nil {</span>
<span class="diff-unchanged">  		return apisv1alpha1.SystemConfig{}, err</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	config := apisv1alpha1.SystemConfig{</span>
<span class="diff-unchanged">  		Mode:             apisv1alpha1.SystemMode(SystemModeDRBD),</span>
<span class="diff-unchanged">  		MaxHAVolumeCount: defaultHAVolumeTotalCount,</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  </span>
<span class="diff-unchanged">  	switch config.Mode {</span>
<span class="diff-unchanged">  	case apisv1alpha1.SystemModeDRBD:</span>
<span class="diff-unchanged">  		{</span>
<span class="diff-unchanged">  			config.DRBD = &apisv1alpha1.DRBDSystemConfig{</span>
<span class="diff-unchanged">  				StartPort: defaultDRBDStartPort,</span>
<span class="diff-unchanged">  			}</span>
<span class="diff-unchanged">  		}</span>
<span class="diff-unchanged">  	}</span>
<span class="diff-unchanged">  	return config, nil</span>
<span class="diff-unchanged">  }</span></code></pre>
                    </details>
                </td>
                <td>
                    <details>
                        <summary>View More</summary>
                        <div><strong>STDERR:</strong> <pre><code class="language-go"># github.com/hwameistor/hwameistor/pkg/local-storage/controller/localvolume
pkg/local-storage/controller/localvolume/localvolume_controller_test.go:23:1: expected declaration, found sigs
</code></pre></div>
                        <div><strong>STDOUT:</strong> <pre><code class="language-go">FAIL	github.com/hwameistor/hwameistor/pkg/local-storage/controller/localvolume [setup failed]
FAIL
</code></pre></div>
                        <div><strong>Test Code:</strong> <pre><code class="language-go">func TestAddFunctionControllerCreationError(t *testing.T) {
    cli, s := CreateFakeClient()
    mgr := &fakeManager{client: cli, scheme: s}

    // Mock the controller.New function to simulate a failure
    originalControllerNew := controller.New
    defer func() { controller.New = originalControllerNew }()
    controller.New = func(name string, mgr manager.Manager, options controller.Options) (controller.Controller, error) {
        return nil, fmt.Errorf("mock controller creation failure")
    }

    err := Add(mgr)
    if err == nil {
        t.Errorf("Expected error when controller creation fails, but got nil")
    }
}
</code></pre></div>
                        <div><strong>Imports:</strong> <pre><code class="language-go">"sigs.k8s.io/controller-runtime/pkg/controller"
</code></pre></div>
                    </details>
                </td>
            </tr>
            
        </table>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/prism.min.js"></script>
    </body>
    </html>
    